<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Overview</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        if (typeof lucide === 'undefined') {
            window.lucide = {
                createIcons: () => { console.warn('Lucide icons failed to load.'); }
            };
        }
    </script>
    <style>
        :root {
            --bg: #09090b;
            --surface: #18181b;
            --surface-accent: #27272a;
            --primary: #ffffff;
            --accent: #3b82f6;
            --text: #fafafa;
            --text-dim: #a1a1aa;
            --border: rgba(255, 255, 255, 0.08);
            --danger: #ef4444;
            --success: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            padding: 32px 24px;
            z-index: 10;
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 48px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary);
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 8px;
            color: var(--text-dim);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--surface-accent);
            color: var(--text);
            transform: translateX(5px);
        }

        /* Unsaved Changes Bar */
        .unsaved-bar {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(24, 24, 27, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid var(--accent);
            padding: 16px 32px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 24px;
            z-index: 1000;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .unsaved-bar.active {
            bottom: 32px;
        }

        .unsaved-text {
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
            background: radial-gradient(circle at 50% -20%, rgba(59, 130, 246, 0.15) 0%, rgba(0, 0, 0, 0) 50%),
                linear-gradient(180deg, #09090b 0%, #000000 100%);
        }

        @keyframes float {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }

            100% {
                transform: translate(50px, 50px) rotate(10deg);
            }
        }

        .header {
            padding: 24px 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: rgba(9, 9, 11, 0.5);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid var(--border);
        }

        .user-info-text {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
        }

        .user-role {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .feedback-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--surface-accent);
        }

        .content {
            padding: 48px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Stats Card */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 48px;
        }

        .stat-card {
            background: rgba(24, 24, 27, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 32px;
            border-radius: 24px;
            cursor: default;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(24, 24, 27, 0.6);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(59, 130, 246, 0.1);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 38px;
            font-weight: 800;
            color: var(--primary);
        }

        /* Widgets */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .widget-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            /* Ensure relative for z-index */
        }

        .widget-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .widget-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .activity-feed {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .activity-item {
            display: flex;
            gap: 16px;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--surface-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-msg {
            font-size: 14px;
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .activity-time {
            font-size: 11px;
            color: var(--text-dim);
        }

        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .module-card {
            background: var(--surface);
            padding: 24px;
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .module-card:hover {
            transform: scale(1.02) translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }

        .expiry-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .expiry-row:last-child {
            border-bottom: none;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 100px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .badge-active {
            background: rgba(16, 185, 129, 0.08);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--surface-accent);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            padding: 16px 24px;
            border-radius: 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            color: white;
            display: none;
            z-index: 10000;
        }

        #modalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: rgba(24, 24, 27, 0.8);
            backdrop-filter: blur(30px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 650px;
            border-radius: 32px;
            padding: 48px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: premiumPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes premiumPop {
            0% {
                transform: scale(0.9) translateY(20px);
                opacity: 0;
            }

            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .btn-master {
            background: var(--primary);
            color: #000;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 10px 20px rgba(255, 255, 255, 0.05);
        }

        .btn-master:hover {
            transform: translateY(-3px) scale(1.02);
            background: #fff;
            box-shadow: 0 15px 30px rgba(255, 255, 255, 0.15);
        }

        .btn-master:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-accent {
            background: var(--accent);
            color: white;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2);
        }

        .btn-accent:hover {
            background: #4f8ff7;
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.3);
        }

        .icon-btn {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: var(--surface-accent);
            border: 1px solid var(--border);
            color: var(--text-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .icon-btn:hover {
            background: var(--primary);
            color: var(--bg);
            transform: scale(1.1) rotate(5deg);
        }

        .icon-btn.btn-delete:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        input,
        textarea,
        select {
            width: 100%;
            background: var(--surface-accent);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: white;
            padding: 12px 16px;
            outline: none;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        /* Feedback Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #18181b;
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 600px;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.2s;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            color: var(--text-dim);
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: white;
        }

        /* Custom Select (Premium OLED) */
        .custom-select {
            position: relative;
            width: 100%;
            cursor: pointer;
            user-select: none;
        }

        .select-trigger {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            padding: 12px 16px;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .custom-select:hover .select-trigger {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.08);
        }

        .select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface-accent);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-top: 8px;
            display: none;
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .select-options::-webkit-scrollbar {
            width: 6px;
        }

        .select-options::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        /* Switch Toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .log-card {
            background: rgba(15, 15, 18, 0.6);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .log-card:hover {
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            background: rgba(20, 20, 25, 0.8);
        }

        .log-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-card-title {
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .color-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .color-input-wrapper label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .color-picker-custom {
            height: 40px;
            width: 100%;
            border-radius: 8px;
            background: #000;
            border: 1px solid var(--border);
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .color-picker-custom input[type="color"] {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 150%;
            height: 150%;
            padding: 0;
            margin: 0;
            border: none;
            cursor: pointer;
        }

        .log-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .tier-badge {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: black;
            font-weight: 800;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
        }

        input:checked+.slider {
            background-color: #2ecc71;
            /* Green from image */
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        .slider.round {
            border-radius: 22px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .system-form {
            animation: slideDown 0.3s ease-out;
        }

        .automod-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .automod-card {
            background: rgba(15, 15, 18, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: all 0.2s ease;
        }

        .automod-card:hover {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.03);
            transform: translateY(-2px);
        }

        .automod-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .automod-card-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .automod-icon-wrapper {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
        }

        .automod-card:hover .automod-icon-wrapper {
            color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .automod-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #fff;
        }

        .automod-setup-btn {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .automod-setup-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .mod-command-row {
            background: rgba(15, 15, 18, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .mod-command-row:hover {
            background: rgba(255, 255, 255, 0.03);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .mod-info h4 {
            margin: 0;
            font-size: 15px;
            font-weight: 700;
            color: #fff;
        }

        .mod-info p {
            margin: 4px 0 0;
            font-size: 12px;
            color: var(--text-dim);
        }

        .mod-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .btn-edit-small {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit-small:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .responder-entry {
            background: rgba(15, 15, 18, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 24px;
            align-items: center;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .responder-entry:hover {
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .responder-entry input {
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            width: 100%;
            padding: 4px 0;
        }

        .responder-entry input:focus {
            outline: none;
        }

        .custom-select.active {
            z-index: 1000;
        }

        .custom-select.active .select-options {
            display: block;
        }

        .custom-select.active .select-trigger {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.1);
        }

        .custom-select.active .select-trigger i {
            transform: rotate(180deg);
        }

        .option-item {
            padding: 12px 16px;
            color: var(--text-dim);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .option-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        /* Impersonation Banner */
        .impersonation-banner {
            display: none;
            background: linear-gradient(90deg, #ef4444 0%, #991b1b 100%);
            color: white;
            padding: 12px 24px;
            font-weight: 600;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .impersonation-banner .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .impersonation-banner .btn-exit {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .impersonation-banner .btn-exit:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0);
            }
        }

        body.impersonating {
            padding-top: 52px;
        }

        .option-item.selected {
            color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        /* Setup Menu Styles */
        .setup-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            color: #d1d5db;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 2px;
        }

        .setup-item i:not(.status-icon) {
            width: 18px;
            height: 18px;
            color: #9ca3af;
        }

        .setup-item .status-icon {
            margin-left: auto;
            width: 16px;
            height: 16px;
            color: #10b981;
            opacity: 1;
        }

        .setup-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .setup-item.active {
            background: #5865f2;
            color: white;
        }

        .setup-item.active i {
            color: white !important;
        }

        /* Premium Setup Item Cards */
        .setup-item-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .setup-item-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .setup-item-card h3 {
            transition: color 0.2s;
        }

        .setup-item-card:hover h3 {
            color: var(--accent);
        }

        .dropdown-search {
            width: 100%;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.2);
            border: none;
            border-bottom: 1px solid var(--border);
            color: white;
            font-size: 13px;
            outline: none;
        }

        /* Advanced Responder Modal */
        .responder-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 650px;
            max-width: 90vw;
            background: #0f0f12;
            border: 1px solid var(--border);
            border-radius: 24px;
            z-index: 2000;
            padding: 32px;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .responder-modal.active {
            display: block;
            animation: modal-in 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modal-in {
            from {
                opacity: 0;
                transform: translate(-50%, -45%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1999;
            display: none;
        }

        .modal-overlay.active {
            display: block;
        }

        .responder-field-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .responder-input-wrapper {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.2s;
        }

        .responder-input-wrapper:focus-within {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.05);
        }

        .responder-input-wrapper label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }

        .responder-input-wrapper input,
        .responder-input-wrapper textarea {
            background: transparent;
            border: none;
            color: white;
            width: 100%;
            font-size: 14px;
        }

        .responder-input-wrapper textarea {
            min-height: 100px;
            resize: vertical;
        }

        .variable-tag {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .variable-tag:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .badge-random {
            background: #5865f2;
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 800;
            margin-left: 8px;
        }

        .responder-grid-advanced {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .nav-submenu {
            display: flex;
            /* Force flex instead of none */
            flex-direction: column;
            padding-left: 24px;
            gap: 4px;
            margin-top: 4px;
            margin-bottom: 8px;
        }

        .nav-submenu.active {
            display: flex;
        }

        .nav-item.sub {
            padding: 10px 16px;
            font-size: 13px;
            color: var(--text-dim);
            border-left: 2px solid transparent;
            background: transparent;
            margin: 0;
            border-radius: 0;
            opacity: 0;
            transform: translateX(-10px);
        }

        .nav-submenu.active .nav-item.sub {
            animation: subItemSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .nav-submenu.active .nav-item.sub:nth-child(1) {
            animation-delay: 0.05s;
        }

        .nav-submenu.active .nav-item.sub:nth-child(2) {
            animation-delay: 0.1s;
        }

        .nav-submenu.active .nav-item.sub:nth-child(3) {
            animation-delay: 0.15s;
        }

        .nav-submenu.active .nav-item.sub:nth-child(4) {
            animation-delay: 0.2s;
        }

        .nav-submenu.active .nav-item.sub:nth-child(5) {
            animation-delay: 0.25s;
        }

        .nav-submenu.active .nav-item.sub:nth-child(6) {
            animation-delay: 0.3s;
        }

        .nav-submenu.active .nav-item.sub:nth-child(7) {
            animation-delay: 0.35s;
        }

        .nav-submenu.active .nav-item.sub:nth-child(8) {
            animation-delay: 0.4s;
        }

        .nav-submenu.active .nav-item.sub:nth-child(9) {
            animation-delay: 0.45s;
        }

        .nav-submenu.active .nav-item.sub:nth-child(10) {
            animation-delay: 0.5s;
        }

        @keyframes subItemSlideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .nav-item.sub:hover {
            color: white;
            background: rgba(255, 255, 255, 0.03);
            border-left-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.sub.active {
            color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
            border-left-color: var(--accent);
            font-weight: 600;
            opacity: 1;
            transform: translateX(0);
        }

        .menu-arrow {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nav-item.open .menu-arrow {
            transform: rotate(180deg);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div id="unsavedChangesBar" class="unsaved-bar">
        <div class="unsaved-text">
            <i data-lucide="alert-circle" style="color: var(--accent); width: 20px;"></i>
            <span>Careful â€” you have unsaved changes!</span>
        </div>
        <div style="display: flex; gap: 12px; align-items: center;">
            <button onclick="saveModuleConfig()" class="btn-master btn-accent"
                style="padding: 8px 24px; font-size: 13px;">
                Save Changes
            </button>
            <button onclick="discardChanges()"
                style="background: transparent; color: var(--text-dim); border: none; cursor: pointer; font-size: 13px; font-weight: 500; padding: 0 12px;">
                Reset
            </button>
        </div>
    </div>

    <div id="impersonationBanner" class="impersonation-banner">
        <div class="user-info">
            <i data-lucide="user-cog" style="width: 20px;"></i>
            <span>Impersonation Mode: Acting as <b id="impersonatedUserDisplay">...</b></span>
        </div>
        <button onclick="exitImpersonation()" class="btn-exit">
            <i data-lucide="log-out" style="width: 16px;"></i>
            Exit & Return
        </button>
    </div>

    <aside class="sidebar">
        <div class="logo">
            <i data-lucide="code-xml" style="width:24px; height:24px; color:var(--accent);"></i> Client Area
        </div>
        <nav>
            <div class="nav-item active" onclick="switchView('overview', this)">
                <i data-lucide="layout-dashboard" style="width:20px; height:20px;"></i>
                Overview
            </div>

            <div id="nav-system-group" style="display: none;">
                <div class="nav-item open" id="nav-system-setup" style="cursor: default;">
                    <i data-lucide="ticket" style="width:20px; height:20px;"></i>
                    System Setup
                </div>
                <div id="system-submenu" class="nav-submenu active">
                    <div class="nav-item sub" onclick="selectSetupOption('Moderation', this)">
                        <i data-lucide="gavel" style="width: 16px; opacity: 0.8;"></i> Moderation
                    </div>
                    <div class="nav-item sub" onclick="selectSetupOption('Automod', this)">
                        <i data-lucide="shield" style="width: 16px; opacity: 0.8;"></i> Automod
                    </div>
                    <div class="nav-item sub" onclick="selectSetupOption('Responder', this)">
                        <i data-lucide="bot" style="width: 16px; opacity: 0.8;"></i> Auto Responder
                    </div>

                    <div class="nav-item sub" onclick="selectSetupOption('Roles', this)">
                        <i data-lucide="users" style="width: 16px; opacity: 0.8;"></i> Auto Roles
                    </div>
                    <div class="nav-item sub" onclick="selectSetupOption('Logs', this)">
                        <i data-lucide="scroll" style="width: 16px; opacity: 0.8;"></i> Logs
                    </div>
                </div>
            </div>

            <div class="nav-item" onclick="switchView('tickets', this)" id="nav-setup">
                <i data-lucide="settings" style="width:20px; height:20px;"></i>
                Module Config
            </div>
            <!-- Client only sees Overview & Tickets -->
        </nav>
        <div class="nav-item" onclick="openFeedbackModal()" style="margin-top: auto; transition: all 0.2s;">
            <i data-lucide="message-square" style="width:20px; height:20px;"></i>
            Feedback
        </div>
        <div class="nav-item" style="color: var(--danger); transition: all 0.2s;"
            onmouseover="this.style.transform='translateX(8px)'; this.style.color='white'; this.style.background='var(--danger)'"
            onmouseout="this.style.transform='translateX(0)'; this.style.color='var(--danger)'; this.style.background='transparent'"
            onclick="logout()">
            <i data-lucide="log-out" style="width:20px; height:20px;"></i>
            Logout
        </div>
    </aside>

    <main class="main">
        <header class="header">
            <div>
                <h1 style="font-size: 24px; font-weight: 800; letter-spacing: -0.02em;">Overview</h1>
                <p style="font-size: 13px; color: var(--text-dim); margin-top: 4px;">Welcome back to your dashboard</p>
            </div>
            <div class="user-profile" id="userProfileHeader">
                <div class="user-info-text" style="text-align: right;">
                    <span class="user-name" id="usernameDisplay">...</span>
                    <span class="user-role" id="userRoleDisplay">Client</span>
                </div>
                <img src="https://cdn.discordapp.com/embed/avatars/0.png" class="user-avatar" id="userAvatarDisplay">
            </div>
        </header>

        <div class="content">
            <!-- Overview View -->
            <div id="overviewView">
                <!-- Global Reach Section -->
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 18px; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
                        <i data-lucide="globe" style="color:var(--accent); width: 20px;"></i> Platform Network Insights
                    </h2>
                    <div class="stats-row" style="margin-bottom: 32px;">
                        <div class="stat-card"
                            style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);">
                            <p class="stat-label">Total Satisfied Clients</p>
                            <p class="stat-value" id="stat-global-users">0</p>
                            <p style="font-size: 12px; color: var(--text-dim); margin-top: 8px;">Active users in our
                                ecosystem</p>
                        </div>
                        <div class="stat-card">
                            <p class="stat-label">Total Licenses Used</p>
                            <p class="stat-value" id="stat-licenses-issued">0</p>
                            <p style="font-size: 12px; color: var(--text-dim); margin-top: 8px;">Across all modules</p>
                        </div>
                        <div class="stat-card">
                            <p class="stat-label">Modules Sold</p>
                            <p class="stat-value" id="stat-modules-sold">0</p>
                            <p style="font-size: 12px; color: var(--text-dim); margin-top: 8px;">Life-time sales</p>
                        </div>
                    </div>

                    <!-- Your Services Section -->
                    <h2 style="font-size: 18px; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
                        <i data-lucide="layout-grid" style="color:var(--accent); width: 20px;"></i> Your Active Services
                    </h2>
                    <div id="services-container" class="module-grid">
                        <!-- Populated dynamically by JS -->
                    </div>

                </div>
            </div>

            <!-- System Setup View -->
            <div id="systemSetupView" style="display: none;">
                <div style="margin-bottom: 32px;">
                    <h2 id="system-setup-main-title"
                        style="font-size: 18px; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
                        <i data-lucide="ticket" style="color:var(--accent); width: 20px;"></i> Tickets System Setup
                    </h2>

                    <!-- Main Options List -->
                    <div id="system-options-container" style="display: grid; gap: 16px; max-width: 900px;">
                        <!-- Moderation -->
                        <div class="setup-item-card" onclick="selectSetupOption('Moderation')">
                            <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                <div
                                    style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="shield" style="width: 24px; color: var(--accent);"></i>
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Moderation Commands</h3>
                                    <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-dim);">Manage
                                        administrative and moderation tools</p>
                                </div>
                            </div>
                            <label class="switch" onclick="event.stopPropagation();">
                                <input type="checkbox" id="moderation_enabled_main"
                                    onchange="syncToggle('moderation_enabled', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <!-- Automod -->
                        <div class="setup-item-card" onclick="selectSetupOption('Automod')">
                            <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                <div
                                    style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="shield-check" style="width: 24px; color: var(--accent);"></i>
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Automod</h3>
                                    <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-dim);">Protect your
                                        server from spam and malicious content</p>
                                </div>
                            </div>
                            <label class="switch" onclick="event.stopPropagation();">
                                <input type="checkbox" id="automod_enabled_main"
                                    onchange="syncToggle('automod_enabled', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <!-- Auto Responder -->
                        <div class="setup-item-card" onclick="selectSetupOption('Responder')">
                            <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                <div
                                    style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="message-square" style="width: 24px; color: var(--accent);"></i>
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Auto Responder</h3>
                                    <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-dim);">Automated
                                        replies to specific trigger words</p>
                                </div>
                            </div>
                            <label class="switch" onclick="event.stopPropagation();">
                                <input type="checkbox" id="responder_enabled_main"
                                    onchange="syncToggle('responder_enabled', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>



                        <!-- Auto Roles -->
                        <div class="setup-item-card" onclick="selectSetupOption('Roles')">
                            <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                <div
                                    style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="users" style="width: 24px; color: var(--accent);"></i>
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Auto Roles</h3>
                                    <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-dim);">Automatically
                                        assign roles to new members</p>
                                </div>
                            </div>
                            <label class="switch" onclick="event.stopPropagation();">
                                <input type="checkbox" id="auto_roles_enabled_main"
                                    onchange="syncToggle('auto_roles_enabled', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <!-- Logging System -->
                        <div class="setup-item-card" onclick="selectSetupOption('Logs')">
                            <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                <div
                                    style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="history" style="width: 24px; color: var(--accent);"></i>
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Logging System</h3>
                                    <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-dim);">Enable or
                                        disable specific server event logs</p>
                                </div>
                            </div>
                            <label class="switch" onclick="event.stopPropagation();">
                                <input type="checkbox" id="logs_enabled_main"
                                    onchange="syncToggle('logs_enabled', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Dynamic Form Container -->
                    <div id="system-form-container" style="display: none;">
                        <!-- Auto Roles Form -->
                        <div id="form-Roles" class="system-form" style="display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; background: rgba(255,255,255,0.02); padding: 20px; border-radius: 16px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div
                                        style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i data-lucide="users" style="width: 24px; color: var(--accent);"></i>
                                    </div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Auto Roles</h3>
                                        <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-dim);">
                                            Automatically assign roles to new members</p>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="auto_roles_enabled"
                                        onchange="syncToggle('auto_roles_enabled', this.checked)">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="widget-card" style="padding: 24px;">
                                <div style="margin-bottom: 24px;">
                                    <label
                                        style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Auto
                                        Roles</label>
                                    <div class="custom-select" id="select_auto_roles_container">
                                        <input type="hidden" id="cfg_auto_roles" value="">
                                        <div class="select-trigger" onclick="toggleCustomSelect(this)">
                                            <span>Select ..</span>
                                            <i data-lucide="chevron-down" style="width: 16px;"></i>
                                        </div>
                                        <div class="select-options">
                                            <input type="text" class="dropdown-search" placeholder="Search roles..."
                                                onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                                            <div class="options-list" id="auto_roles_list">
                                                <div class="option-item" data-value=""
                                                    onclick="selectCustomOption('', 'Select ..', 'auto_roles')">Select
                                                    ..</div>
                                                <!-- Populated by JS -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 8px;">
                                    <label
                                        style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Auto
                                        Roles For Bots</label>
                                    <div class="custom-select" id="select_auto_roles_bots_container">
                                        <input type="hidden" id="cfg_auto_roles_bots" value="">
                                        <div class="select-trigger" onclick="toggleCustomSelect(this)">
                                            <span>Select ..</span>
                                            <i data-lucide="chevron-down" style="width: 16px;"></i>
                                        </div>
                                        <div class="select-options">
                                            <input type="text" class="dropdown-search" placeholder="Search roles..."
                                                onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                                            <div class="options-list" id="auto_roles_bots_list">
                                                <div class="option-item" data-value=""
                                                    onclick="selectCustomOption('', 'Select ..', 'auto_roles_bots')">
                                                    Select ..</div>
                                                <!-- Populated by JS -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Automod Form -->
                        <div id="form-Automod" class="system-form" style="display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; background: rgba(255,255,255,0.02); padding: 20px; border-radius: 16px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div
                                        style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i data-lucide="shield-check" style="width: 24px; color: var(--accent);"></i>
                                    </div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Automod</h3>
                                        <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-dim);">Protect
                                            your server from spam and malicious content</p>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="automod_enabled"
                                        onchange="syncToggle('automod_enabled', this.checked)">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="automod-grid">
                                <!-- Filter Cards -->
                                <div class="automod-card">
                                    <div class="automod-card-header">
                                        <div class="automod-card-info">
                                            <div class="automod-icon-wrapper"><i data-lucide="zap"></i></div>
                                            <span class="automod-title">Spam</span>
                                        </div>
                                        <label class="switch small"><input type="checkbox" id="am_spam_enabled"
                                                onchange="setDirty(true)"><span class="slider round"></span></label>
                                    </div>
                                    <button class="automod-setup-btn" onclick="openAutomodModal('spam')">Need
                                        Setup</button>
                                </div>

                                <div class="automod-card">
                                    <div class="automod-card-header">
                                        <div class="automod-card-info">
                                            <div class="automod-icon-wrapper"><i data-lucide="message-square-off"></i>
                                            </div>
                                            <span class="automod-title">Bad Words</span>
                                        </div>
                                        <label class="switch small"><input type="checkbox" id="am_badwords_enabled"
                                                onchange="setDirty(true)"><span class="slider round"></span></label>
                                    </div>
                                    <button class="automod-setup-btn" onclick="openAutomodModal('badwords')">Need
                                        Setup</button>
                                </div>

                                <div class="automod-card">
                                    <div class="automod-card-header">
                                        <div class="automod-card-info">
                                            <div class="automod-icon-wrapper"><i data-lucide="copy"></i></div>
                                            <span class="automod-title">Duplicated Text</span>
                                        </div>
                                        <label class="switch small"><input type="checkbox" id="am_duplicate_enabled"
                                                onchange="setDirty(true)"><span class="slider round"></span></label>
                                    </div>
                                    <button class="automod-setup-btn" onclick="openAutomodModal('duplicate')">Need
                                        Setup</button>
                                </div>




                                <div class="automod-card">
                                    <div class="automod-card-header">
                                        <div class="automod-card-info">
                                            <div class="automod-icon-wrapper"><i data-lucide="link"></i></div>
                                            <span class="automod-title">Links</span>
                                        </div>
                                        <label class="switch small"><input type="checkbox" id="am_links_enabled"
                                                onchange="setDirty(true)"><span class="slider round"></span></label>
                                    </div>
                                    <button class="automod-setup-btn" onclick="openAutomodModal('links')">Need
                                        Setup</button>
                                </div>






                            </div>

                            <!-- Global Selectors -->
                            <div class="widget-card" style="padding: 24px; display: grid; gap: 24px;">
                                <div>
                                    <label
                                        style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Ignored
                                        Channels</label>
                                    <div class="custom-select" id="select_am_ignored_channels_container">
                                        <input type="hidden" id="cfg_am_ignored_channels" value="">
                                        <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select
                                                ..</span><i data-lucide="chevron-down" style="width: 16px;"></i></div>
                                        <div class="select-options">
                                            <input type="text" class="dropdown-search" placeholder="Search channels..."
                                                onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                                            <div class="options-list" id="am_ignored_channels_list"></div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label
                                        style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Ignored
                                        Roles</label>
                                    <div class="custom-select" id="select_am_ignored_roles_container">
                                        <input type="hidden" id="cfg_am_ignored_roles" value="">
                                        <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select
                                                ..</span><i data-lucide="chevron-down" style="width: 16px;"></i></div>
                                        <div class="select-options">
                                            <input type="text" class="dropdown-search" placeholder="Search roles..."
                                                onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                                            <div class="options-list" id="am_ignored_roles_list"></div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label
                                        style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Only
                                        Images Channels</label>
                                    <div class="custom-select" id="select_am_images_channels_container">
                                        <input type="hidden" id="cfg_am_images_channels" value="">
                                        <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select
                                                ..</span><i data-lucide="chevron-down" style="width: 16px;"></i></div>
                                        <div class="select-options">
                                            <input type="text" class="dropdown-search" placeholder="Search channels..."
                                                onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                                            <div class="options-list" id="am_images_channels_list"></div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label
                                        style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Only
                                        YouTube Links Channels</label>
                                    <div class="custom-select" id="select_am_youtube_channels_container">
                                        <input type="hidden" id="cfg_am_youtube_channels" value="">
                                        <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select
                                                ..</span><i data-lucide="chevron-down" style="width: 16px;"></i></div>
                                        <div class="select-options">
                                            <input type="text" class="dropdown-search" placeholder="Search channels..."
                                                onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                                            <div class="options-list" id="am_youtube_channels_list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Moderation Form -->
                        <div id="form-Moderation" class="system-form" style="display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; background: rgba(255,255,255,0.02); padding: 20px; border-radius: 16px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div
                                        style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i data-lucide="shield" style="width: 24px; color: var(--accent);"></i>
                                    </div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Moderation Commands
                                        </h3>
                                        <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-dim);">Manage
                                            administrative and moderation tools</p>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="moderation_enabled"
                                        onchange="syncToggle('moderation_enabled', this.checked)">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="mod-commands-list">
                                <div class="mod-command-row">
                                    <div class="mod-info">
                                        <h4>/ban</h4>
                                        <p>Bans a member.</p>
                                    </div>
                                    <div class="mod-actions">
                                        <button class="btn-edit-small"
                                            onclick="openModerationModal('ban')">Edit</button>
                                        <label class="switch small">
                                            <input type="checkbox" id="mod_ban_enabled" onchange="setDirty(true)">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mod-command-row">
                                    <div class="mod-info">
                                        <h4>/unban</h4>
                                        <p>Unbans a member.</p>
                                    </div>
                                    <div class="mod-actions">
                                        <button class="btn-edit-small"
                                            onclick="openModerationModal('unban')">Edit</button>
                                        <label class="switch small">
                                            <input type="checkbox" id="mod_unban_enabled" onchange="setDirty(true)">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mod-command-row">
                                    <div class="mod-info">
                                        <h4>/kick</h4>
                                        <p>Kicks a member.</p>
                                    </div>
                                    <div class="mod-actions">
                                        <button class="btn-edit-small"
                                            onclick="openModerationModal('kick')">Edit</button>
                                        <label class="switch small">
                                            <input type="checkbox" id="mod_kick_enabled" onchange="setDirty(true)">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mod-command-row">
                                    <div class="mod-info">
                                        <h4>/timeout</h4>
                                        <p>Timeouts a member.</p>
                                    </div>
                                    <div class="mod-actions">
                                        <button class="btn-edit-small"
                                            onclick="openModerationModal('timeout')">Edit</button>
                                        <label class="switch small">
                                            <input type="checkbox" id="mod_timeout_enabled" onchange="setDirty(true)">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mod-command-row">
                                    <div class="mod-info">
                                        <h4>/untimeout</h4>
                                        <p>Removes a timeout from a member.</p>
                                    </div>
                                    <div class="mod-actions">
                                        <button class="btn-edit-small"
                                            onclick="openModerationModal('untimeout')">Edit</button>
                                        <label class="switch small">
                                            <input type="checkbox" id="mod_untimeout_enabled" onchange="setDirty(true)">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mod-command-row">
                                    <div class="mod-info">
                                        <h4>/clear</h4>
                                        <p>Cleans up channel messages.</p>
                                    </div>
                                    <div class="mod-actions">
                                        <button class="btn-edit-small"
                                            onclick="openModerationModal('clear')">Edit</button>
                                        <label class="switch small">
                                            <input type="checkbox" id="mod_clear_enabled" onchange="setDirty(true)">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mod-command-row">
                                    <div class="mod-info">
                                        <h4>/lock</h4>
                                        <p>Disables @everyone from sending messages in specific channel.</p>
                                    </div>
                                    <div class="mod-actions">
                                        <button class="btn-edit-small"
                                            onclick="openModerationModal('lock')">Edit</button>
                                        <label class="switch small">
                                            <input type="checkbox" id="mod_lock_enabled" onchange="setDirty(true)">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mod-command-row">
                                    <div class="mod-info">
                                        <h4>/unlock</h4>
                                        <p>Allows @everyone to send messages in specific channel.</p>
                                    </div>
                                    <div class="mod-actions">
                                        <button class="btn-edit-small"
                                            onclick="openModerationModal('unlock')">Edit</button>
                                        <label class="switch small">
                                            <input type="checkbox" id="mod_unlock_enabled" onchange="setDirty(true)">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Auto Responder Form -->
                        <div id="form-Responder" class="system-form" style="display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; background: rgba(255,255,255,0.02); padding: 20px; border-radius: 16px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div
                                        style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i data-lucide="message-square" style="width: 24px; color: var(--accent);"></i>
                                    </div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Auto Responder</h3>
                                        <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-dim);">Automated
                                            replies to specific trigger words</p>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="responder_enabled"
                                        onchange="syncToggle('responder_enabled', this.checked)">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="widget-card" style="padding: 24px;">
                                <button onclick="openResponderModal()" class="btn-master"
                                    style="width: auto; padding: 10px 20px; font-size: 13px; margin-bottom: 24px;">
                                    <i data-lucide="plus" style="width: 16px;"></i> Add Response
                                </button>

                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 24px; padding: 0 20px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 12px;">
                                    <span
                                        style="font-size: 12px; color: var(--text-dim); font-weight: 600; text-transform: uppercase;">Trigger</span>
                                    <span
                                        style="font-size: 12px; color: var(--text-dim); font-weight: 600; text-transform: uppercase;">Action</span>
                                    <div style="width: 32px;"></div>
                                </div>

                                <div id="responder-list">
                                    <!-- Dynamic rows here -->
                                </div>
                            </div>
                        </div>

                        <!-- Logs Form -->
                        <div id="form-Logs" class="system-form" style="display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; background: rgba(255,255,255,0.02); padding: 20px; border-radius: 16px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div
                                        style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i data-lucide="history" style="width: 24px; color: var(--accent);"></i>
                                    </div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Logging System</h3>
                                        <p style="margin: 4px 0 0; font-size: 13px; color: var(--text-dim);">Enable or
                                            disable specific server event logs</p>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="logs_enabled"
                                        onchange="syncToggle('logs_enabled', this.checked)">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div id="logs-grid" class="log-grid">
                                <!-- Dynamic log cards populated by populateLogs() -->
                            </div>
                        </div>

                        <!-- Fallback for unimplemented forms -->
                        <div id="form-unimplemented" class="system-form" style="display: none;">
                            <div class="widget-card" style="padding: 48px; text-align: center;">
                                <i data-lucide="construction"
                                    style="width: 48px; height: 48px; color: var(--accent); margin-bottom: 16px;"></i>
                                <h3 style="margin: 0; font-size: 18px;">Under Construction</h3>
                                <p style="color: var(--text-dim); margin-top: 8px;">This setting module is currently
                                    being implemented.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tickets Setup View -->
            <div id="ticketsView" style="display: none;">
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 18px; margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
                        <i id="setup-icon" data-lucide="bot" style="color:var(--accent); width: 20px;"></i>
                        <span id="setup-title">Service Configuration</span>
                    </h2>

                    <!-- Module Selector -->
                    <div class="widget-card" id="moduleSelectContainer" style="margin-bottom: 24px;">
                        <div class="widget-header">
                            <div class="widget-title" id="moduleSelectTitle">Select Module to Configure</div>
                        </div>
                        <select id="moduleSelect" onchange="loadModuleConfig()"
                            style="width: 100%; padding: 12px; background: var(--surface-accent); border: 1px solid var(--border); border-radius: 12px; color: white;">
                            <option value="">Choose a module...</option>
                        </select>
                    </div>

                    <div id="configContainer" style="display: none;">
                        <!-- Global Config (Token) -->
                        <div class="widget-card" style="margin-bottom: 24px;">
                            <div class="widget-header">
                                <div class="widget-title">Global Configuration</div>
                            </div>
                            <div style="display: grid; gap: 16px;">
                                <div>
                                    <label id="token_label_1"
                                        style="display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 6px;">Discord
                                        Bot Token</label>
                                    <input type="password" id="cfg_bot_token"
                                        placeholder="MTIzNDU2Nzg5MDEyMzQ1Njc4OQ...">
                                </div>
                                <div id="multi_token_fields"
                                    style="display: none; grid-template-columns: 1fr; gap: 16px;">
                                    <div>
                                        <label
                                            style="display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 6px;">Token
                                            2 (Optional)</label>
                                        <input type="password" id="cfg_bot_token_2"
                                            placeholder="MTIzNDU2Nzg5MDEyMzQ1Njc4OQ...">
                                    </div>
                                    <div>
                                        <label
                                            style="display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 6px;">Token
                                            3 (Optional)</label>
                                        <input type="password" id="cfg_bot_token_3"
                                            placeholder="MTIzNDU2Nzg5MDEyMzQ1Njc4OQ...">
                                    </div>
                                    <div>
                                        <label
                                            style="display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 6px;">Token
                                            4 (Optional)</label>
                                        <input type="password" id="cfg_bot_token_4"
                                            placeholder="MTIzNDU2Nzg5MDEyMzQ1Njc4OQ...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ticket Fields -->
                        <div id="ticketFields" class="dashboard-grid"
                            style="display: none; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                            <div class="widget-card">
                                <div class="widget-header">
                                    <div class="widget-title">System Channels</div>
                                </div>
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Transcript
                                            Log ID</label>
                                        <input type="text" id="cfg_transcript_log_id" placeholder="Channel ID"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Feedback
                                            Channel ID</label>
                                        <input type="text" id="cfg_feedback_channel_id" placeholder="Channel ID"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                </div>
                            </div>
                            <div class="widget-card">
                                <div class="widget-header">
                                    <div class="widget-title">Categories & Roles</div>
                                </div>
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Open
                                            Category ID</label>
                                        <input type="text" id="cfg_current_open_cat_id" placeholder="Category ID"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Closed
                                            Category ID</label>
                                        <input type="text" id="cfg_current_closed_cat_id" placeholder="Category ID"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                    <!-- Feedback Method moved to Feedback Settings widget -->
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Staff
                                            Role ID</label>
                                        <input type="text" id="cfg_required_role_id" placeholder="Role ID"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                </div>
                            </div>

                            <div class="widget-card" style="grid-column: span 2;" id="feedback_settings_card">
                                <div class="widget-header">
                                    <div class="widget-title">FeedBack Settings</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                                    <div style="grid-column: span 1;">
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Feedback
                                            Option</label>
                                        <div class="custom-select" id="select_feedback_method_container">
                                            <input type="hidden" id="cfg_feedback_method" value="1">
                                            <div class="select-trigger" onclick="toggleCustomSelect(this)">
                                                <span>Option 1: Stars Buttons</span>
                                                <i data-lucide="chevron-down" style="width: 16px;"></i>
                                            </div>
                                            <div class="select-options">
                                                <div class="option-item selected" data-value="1"
                                                    onclick="selectFeedbackMethod('1', 'Option 1: Stars Buttons')">
                                                    Option 1: Stars Buttons</div>
                                                <div class="option-item" data-value="2"
                                                    onclick="selectFeedbackMethod('2', 'Option 2: Detail Modal + GIF')">
                                                    Option 2: Detail Modal + GIF</div>
                                                <div class="option-item" data-value="3"
                                                    onclick="selectFeedbackMethod('3', 'Option 3: Professional Image')">
                                                    Option 3: Professional Image</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="method2_extras" style="display: none;">
                                        <div
                                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                            <div>
                                                <label
                                                    style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Product
                                                    Label</label>
                                                <input type="text" id="cfg_fb_m2_prod_label" placeholder="Product"
                                                    style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                            </div>
                                            <div>
                                                <label
                                                    style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Seller
                                                    Label</label>
                                                <input type="text" id="cfg_fb_m2_sell_label" placeholder="Seller"
                                                    style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                            </div>
                                            <div>
                                                <label
                                                    style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Rating
                                                    Label</label>
                                                <input type="text" id="cfg_fb_m2_rate_label" placeholder="Rating: /10"
                                                    style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                            </div>
                                            <div>
                                                <label
                                                    style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Experience
                                                    Label</label>
                                                <input type="text" id="cfg_fb_m2_exp_label" placeholder="Experience"
                                                    style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                            </div>
                                        </div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Option
                                            2: Feedback GIF URL</label>
                                        <input type="text" id="cfg_feedback_gif_url" placeholder="https://..."
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                    <div id="method3_extras" style="display: none;">
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Option
                                            3: Background Image URL</label>
                                        <input type="text" id="cfg_fb_m3_bg_url" placeholder="https://..."
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                </div>
                            </div>
                            <div class="widget-card" style="grid-column: span 2;">
                                <div class="widget-header">
                                    <div class="widget-title">Embed Appearance</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div style="grid-column: span 2;">
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Title</label>
                                        <input type="text" id="cfg_embed_title" placeholder="Support Box"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                    <div style="grid-column: span 2;">
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Description</label>
                                        <textarea id="cfg_embed_description" rows="2"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white; resize: none;"></textarea>
                                    </div>
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Thumbnail
                                            URL</label>
                                        <input type="text" id="cfg_thumbnail_url" placeholder="https://..."
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Banner
                                            Image URL</label>
                                        <input type="text" id="cfg_image_url" placeholder="https://..."
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>

                                    <div style="grid-column: span 2;">
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Embed
                                            Color (Hex)</label>
                                        <input type="text" id="cfg_embed_color" placeholder="#2F3136"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                </div>
                            </div>
                            <div class="widget-card" style="grid-column: span 2;">
                                <div class="widget-header">
                                    <div class="widget-title">Ticket Type Options</div>
                                    <button onclick="addOption()" class="btn-master"
                                        style="padding: 8px 16px; font-size: 13px; background: var(--surface-accent); color: white;">
                                        <i data-lucide="plus" style="width: 14px;"></i> Add New Option
                                    </button>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label
                                        style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Menu
                                        Placeholder</label>
                                    <input type="text" id="ticket_menu_placeholder"
                                        placeholder="Select A Ticket Type..."
                                        style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white; font-size:13px;">
                                </div>
                                <div id="optionsList" style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                                    <!-- Dynamic options here -->
                                </div>
                            </div>
                        </div>

                        <!-- Broadcast Fields -->
                        <div id="broadcastFields" class="dashboard-grid"
                            style="display: none; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                            <!-- Removed Announcement Embed Settings as per request -->
                            <div class="widget-card" style="grid-column: span 2;">
                                <div class="widget-header">
                                    <div class="widget-title">Broadcast Command Permissions</div>
                                </div>
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Allowed
                                            User IDs (one per line)</label>
                                        <textarea id="bc_allowed_users" rows="5"
                                            placeholder="123456789012345678&#10;987654321098765432&#10;..."
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white; resize: vertical; font-family: monospace;"></textarea>
                                        <p style="font-size: 10px; color: var(--text-dim); margin-top: 6px;">
                                            ðŸ’¡ Enter Discord User IDs (one per line). Only these users can use the
                                            !broadcast command.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rules Fields -->
                        <div id="rulesFields" class="dashboard-grid"
                            style="display: none; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                            <div class="widget-card">
                                <div class="widget-header">
                                    <div class="widget-title">Rules Embed Settings</div>
                                </div>
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Title</label>
                                        <input type="text" id="rules_title"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Description</label>
                                        <textarea id="rules_description" rows="2"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white; resize: none;"></textarea>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <label
                                                style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Menu
                                                Placeholder</label>
                                            <input type="text" id="rules_placeholder" placeholder="Select a section..."
                                                style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                        </div>
                                        <div>
                                            <label
                                                style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Footer
                                                Text</label>
                                            <input type="text" id="rules_footer" placeholder="Click to view rules"
                                                style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                                        <div>
                                            <label
                                                style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Color
                                                (Hex)</label>
                                            <input type="text" id="rules_color" placeholder="#00f1ff"
                                                style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="widget-card">
                                <div class="widget-header">
                                    <div class="widget-title">Media & Visuals</div>
                                </div>
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Thumbnail
                                            URL</label>
                                        <input type="text" id="rules_thumbnail"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                    <div>
                                        <label
                                            style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Banner
                                            Image URL</label>
                                        <input type="text" id="rules_image"
                                            style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:10px; color:white;">
                                    </div>
                                </div>
                            </div>

                            <!-- Rules Management (Always at bottom) -->
                            <div class="widget-card" style="grid-column: span 2;">
                                <div class="widget-header">
                                    <div class="widget-title">Rules Sections Manager</div>
                                    <button onclick="addRule()" class="btn-master"
                                        style="padding: 8px 16px; font-size: 13px; background: var(--surface-accent); color: white;">
                                        <i data-lucide="plus" style="width: 14px;"></i> Add New Section
                                    </button>
                                </div>
                                <div id="rulesContainer" style="display: grid; gap: 16px;">
                                    <!-- Dynamic cards here -->
                                </div>
                            </div>
                        </div>

                        <!-- Send Embed Logic -->
                        <div id="deployEmbedWidget" class="widget-card" style="margin-top: 32px; display: none;">
                            <div class="widget-header">
                                <div class="widget-title" style="display: flex; align-items: center; gap: 10px;">
                                    <i data-lucide="send-to-back" style="width: 18px; color: var(--accent);"></i>
                                    <span>Deploy Embed to Discord</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 16px; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <label
                                        style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 8px; font-weight: 500; letter-spacing: 0.5px;">TARGET
                                        CHANNEL LINK</label>
                                    <div style="position: relative;">
                                        <i data-lucide="link"
                                            style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 14px; color: var(--text-dim);"></i>
                                        <input type="text" id="target_channel_id"
                                            placeholder="https://discord.com/channels/..."
                                            style="width:100%; padding:12px; padding-left: 40px; background:var(--surface); border:1px solid var(--border); border-radius:12px; color:white; font-size: 13px;">
                                    </div>
                                </div>
                                <button onclick="sendEmbed()" class="btn-master"
                                    style="background: var(--accent); color: white; height: 44px; padding: 0 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);">
                                    <i data-lucide="zap" style="width: 16px;"></i> Send Now
                                </button>
                            </div>
                        </div>

                        <!-- Action Bar (Always at bottom) -->
                        <div
                            style="margin-top: 32px; display: flex; justify-content: flex-end; gap: 16px; border-top: 1px solid var(--border); padding-top: 32px;">
                            <button onclick="saveModuleConfig()" class="btn-master btn-accent">
                                <i data-lucide="save" style="width: 18px;"></i> Save All Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modalOverlay" onclick="document.getElementById('modalOverlay').style.display='none'">
        <div class="modal" onclick="event.stopPropagation()">
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let adminUser = '';
        let adminPassword = '';
        let isDirty = false;
        let originalConfig = null;

        async function apiFetch(url, body = {}) {
            // If no credentials are found, we don't automatically redirect yet.
            // We rely on the session cookie.

            try {
                const payload = { ...body };
                if (adminUser && adminPassword) {
                    payload.username = adminUser;
                    payload.password = adminPassword;
                }
                if (localStorage.getItem('impersonate_user')) {
                    payload.impersonate_user = localStorage.getItem('impersonate_user');
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401 || res.status === 403) {
                    // Only redirect if effectively unauthorized
                    // But wait, maybe the endpoint just returns {success:false}
                    // Let's rely on the response content or specific status
                    localStorage.removeItem('adminPassword');
                    localStorage.removeItem('admin_key');
                    window.location.href = '/login';
                    return null;
                }
                const text = await res.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error("Non-JSON response:", text);
                    return { success: false, error: "Server Error: " + (text.substring(0, 50) || "Empty response") };
                }
            } catch (e) {
                console.error("Fetch Error:", e);
                return { success: false, error: "Network Error" };
            }
        }

        function setDirty(value) {
            isDirty = value;
            const bar = document.getElementById('unsavedChangesBar');
            if (bar) {
                if (isDirty) bar.classList.add('active');
                else bar.classList.remove('active');
            }
        }

        // Encryption helpers (same as dashboard)
        function dec(str) {
            try { return decodeURIComponent(atob(str).split('').map((c, i) => String.fromCharCode(c.charCodeAt(0) ^ (i % 255))).join('')); } catch (e) { return ''; }
        }

        function showToast(msg, type = 'info') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast ${type}`; // Add type class for styling
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function showSuccess(msg) {
            showToast(msg, 'success');
        }

        function showError(msg) {
            showToast(msg, 'error');
        }

        function showConfirm(title, message, onConfirm) {
            const overlay = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');

            content.innerHTML = `
                <div style="text-align: center;">
                    <div style="width: 80px; height: 80px; background: rgba(59, 130, 246, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 32px;">
                        <i data-lucide="alert-triangle" style="width: 40px; height: 40px; color: var(--accent);"></i>
                    </div>
                    <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 16px; color: white;">${title}</h2>
                    <p style="color: var(--text-dim); font-size: 16px; margin-bottom: 48px; line-height: 1.6; max-width: 400px; margin-left: auto; margin-right: auto;">${message}</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <button onclick="document.getElementById('modalOverlay').style.display='none'" 
                                style="padding: 16px; background: var(--surface-accent); color: white; border: 1px solid var(--border); border-radius: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;"
                                onmouseover="this.style.background='rgba(255,255,255,0.05)'"
                                onmouseout="this.style.background='var(--surface-accent)'">
                            No, Cancel
                        </button>
                        <button id="confirmBtn" 
                                style="padding: 16px; background: var(--accent); color: white; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2); transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 15px 30px rgba(59, 130, 246, 0.3)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 20px rgba(59, 130, 246, 0.2)'">
                            Yes, Proceed
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('confirmBtn').onclick = () => {
                overlay.style.display = 'none';
                onConfirm();
            };

            overlay.style.display = 'flex';
            lucide.createIcons();
        }

        function logout() {
            if (isDirty) {
                showConfirm("Confirm Logout", "You have unsaved changes. Are you sure you want to logout? All changes will be lost.", () => {
                    localStorage.removeItem('adminPassword');
                    localStorage.removeItem('admin_key');
                    localStorage.removeItem('impersonate_user');
                    window.location.href = '/login';
                });
                return;
            }
            localStorage.removeItem('adminPassword');
            localStorage.removeItem('admin_key');
            localStorage.removeItem('impersonate_user');
            window.location.href = '/login';
        }

        function exitImpersonation() {
            localStorage.removeItem('impersonate_user');
            window.location.href = '/dashboard';
        }

        async function init() {
            lucide.createIcons();

            // Clean Init - No dynamic background scripts
            const u = localStorage.getItem('admin_key');
            const p = localStorage.getItem('adminPassword');
            const imp = localStorage.getItem('impersonate_user');

            if (!u || !p) {
                // Try session hydration
                try {
                    const res = await fetch('/api/auth/me');
                    const me = await res.json();
                    if (me && me.logged_in) {
                        adminUser = me.username;
                        document.getElementById('usernameDisplay').textContent = me.discord_username || me.username;
                        document.getElementById('userRoleDisplay').textContent = me.role;
                        if (me.discord_avatar) {
                            document.getElementById('userAvatarDisplay').src = me.discord_avatar;
                        }
                    } else {
                        window.location.href = '/login';
                        return;
                    }
                } catch (e) {
                    console.error("Session check failed", e);
                    window.location.href = '/login';
                    return;
                }
            } else {
                adminUser = dec(u);
                adminPassword = dec(p);
                document.getElementById('usernameDisplay').textContent = adminUser;
            }

            if (imp) {
                document.body.classList.add('impersonating');
                document.getElementById('impersonationBanner').style.display = 'flex';
                document.getElementById('impersonatedUserDisplay').textContent = imp;
            }

            refresh();
            setInterval(() => refresh(true), 120000); // Increased to 2m auto-refresh to prevent rate-limit
            lucide.createIcons();
        }

        async function refresh(isAuto = false) {
            const data = await apiFetch('/api/stats');
            if (!data || !data.success) return;

            if (data.all_available_modules) {
                window.allAvailableModules = [];
                data.all_available_modules.forEach(cat => {
                    if (cat.bots) {
                        cat.bots.forEach(bot => {
                            window.allAvailableModules.push({ id: bot.id, name: bot.name });
                        });
                    }
                });
            }

            renderClientView(data, isAuto);
        }

        function toggleSidebarMenu(menuId, el) {
            // Logic disabled because user wants it always visible
            showSystemMenu();
            switchView('system_setup', document.getElementById('nav-system-setup'));
        }

        function switchView(view, el) {
            if (isDirty) {
                showConfirm("Unsaved Changes", "You have unsaved configuration changes. Do you want to continue without saving?", () => {
                    setDirty(false);
                    // document.querySelectorAll('.nav-submenu').forEach(m => m.classList.remove('active')); // Removed to keep always visible

                    document.getElementById('overviewView').style.display = view === 'overview' ? 'block' : 'none';
                    document.getElementById('ticketsView').style.display = view === 'tickets' ? 'block' : 'none';
                    document.getElementById('systemSetupView').style.display = view === 'system_setup' ? 'block' : 'none';

                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    if (el) el.classList.add('active');

                    if (view === 'tickets' || view === 'system_setup') {
                        const select = document.getElementById('moduleSelect');
                        if (select && select.value) {
                            loadModuleConfig();
                        } else if (view === 'tickets') {
                            refresh();
                        }
                    }
                    lucide.createIcons();
                });
                return;
            }

            // if (view !== 'system_setup') {
            //    document.querySelectorAll('.nav-submenu').forEach(m => m.classList.remove('active'));
            // }

            document.getElementById('overviewView').style.display = view === 'overview' ? 'block' : 'none';
            document.getElementById('ticketsView').style.display = view === 'tickets' ? 'block' : 'none';
            document.getElementById('systemSetupView').style.display = view === 'system_setup' ? 'block' : 'none';

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (el) el.classList.add('active');

            if (view === 'tickets' || view === 'system_setup') {
                const select = document.getElementById('moduleSelect');
                if (select && select.value) {
                    loadModuleConfig();
                } else if (view === 'tickets') {
                    refresh();
                }
            }
            lucide.createIcons();
        }

        function populateModules(data, isAuto = false) {
            // alert('Debug: populateModules running'); // check execution
            const select = document.getElementById('moduleSelect');
            if (!select) return;

            const card = select.closest('.widget-card');
            const titleEl = card ? card.querySelector('.widget-title') : null;
            const currentValue = select.value;

            let modules = [];
            if (data.raw_modules) {
                data.raw_modules.forEach(cat => {
                    if (cat.bots) {
                        cat.bots.forEach(bot => {
                            modules.push({ id: bot.id, name: bot.name, mid: bot.module_id }); // Preserve both
                        });
                    }
                });
            }

            const uniqueModules = Array.from(new Set(modules.map(m => m.id)))
                .map(id => modules.find(m => m.id === id));

            // Store for feedback modal and rules check - preserve mid
            window.currentLicenses = uniqueModules.map(m => ({ module_id: m.id, module_name: m.name, mid: m.mid }));

            // Conditionally show System Setup group in sidebar
            const hasSystem = uniqueModules.some(m => m.mid && (m.mid.toLowerCase() === 'system' || m.mid.toLowerCase() === 'system_bot' || m.mid.toLowerCase() === 'broadcast_system'));
            const systemGroup = document.getElementById('nav-system-group');
            if (systemGroup) {
                systemGroup.style.display = hasSystem ? 'block' : 'none';
            }

            select.innerHTML = uniqueModules.length > 1 ? '<option value="">Choose a module...</option>' : '';
            uniqueModules.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.name || m.id;
                opt.setAttribute('data-mid', m.mid || '');
                select.appendChild(opt);
            });

            if (uniqueModules.length === 1) {
                const m = uniqueModules[0];
                const isRules = m.mid && m.mid.includes('rules');
                const isSystem = m.mid && (m.mid.toLowerCase() === 'system' || m.mid.toLowerCase() === 'system_bot' || m.mid.toLowerCase() === 'broadcast_system');

                if (card) card.style.display = 'none'; // Always hide selector if only one
                select.value = m.id;

                // Update Setup Titles
                document.getElementById('setup-title').textContent = m.name + ' Configuration';
                document.getElementById('setup-icon').setAttribute('data-lucide', isRules ? 'scroll' : 'ticket');

                // Only rename nav-setup if it's NOT a system bot (system has its own group now)
                if (!isSystem) {
                    document.getElementById('nav-setup').innerHTML = `<i data-lucide="${isRules ? 'scroll' : 'ticket'}" style="width:20px; height:20px;"></i> ${m.name} Setup`;
                } else {
                    document.getElementById('nav-setup').innerHTML = `<i data-lucide="settings" style="width:20px; height:20px;"></i> Module Config`;
                }

                lucide.createIcons();

                // Always load config if view is active
                if (document.getElementById('ticketsView').style.display !== 'none' || document.getElementById('systemSetupView').style.display !== 'none') {
                    loadModuleConfig();
                }
            } else {
                if (card) card.style.display = 'block';
                if (titleEl) titleEl.textContent = 'Select Service to Configure';
                select.style.display = 'block';
                document.getElementById('nav-setup').innerHTML = `<i data-lucide="settings" style="width:20px; height:20px;"></i> Module Config`;

                if (currentValue) {
                    select.value = currentValue;
                    // If we have a selection and view is active, reload config
                    if (document.getElementById('ticketsView').style.display !== 'none' || document.getElementById('systemSetupView').style.display !== 'none') {
                        loadModuleConfig();
                    }
                }
            }
        }

        async function loadModuleConfig() {
            if (isDirty) {
                console.log("Skipping config load: unsaved changes present.");
                return;
            }
            const moduleId = document.getElementById('moduleSelect').value;
            const container = document.getElementById('configContainer');

            if (!moduleId) {
                container.style.display = 'none';
                return;
            }

            try {
                const data = await apiFetch('/api/modules/get_config', {
                    module_id: moduleId
                });

                if (data && data.success) {
                    console.log("Config loaded:", data.config);
                    originalConfig = JSON.parse(JSON.stringify(data.config));
                    fillConfigForm(data.config);
                    setDirty(false);
                    container.style.display = 'grid';

                    // Repopulate dropdowns for the selected module
                    populateAutomodDropdowns();
                } else if (data) {
                    showError("Failed to load: " + (data.error || "Unknown Error"));
                    console.error("Config load error:", data);
                }
            } catch (e) {
                showError("Connection error. Check your internet or login status.");
                console.error("Config fetch error:", e);
            }
        }

        function renderActiveServices(licenses) {
            const container = document.getElementById('services-container');
            if (!container) return;
            container.innerHTML = '';

            if (!licenses || licenses.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; padding: 48px; text-align: center; background: rgba(255,255,255,0.02); border-radius: 20px; border: 1px dashed var(--border);">
                        <i data-lucide="bot-off" style="width: 48px; height: 48px; color: var(--text-dim); margin-bottom: 16px;"></i>
                        <p style="color: var(--text-dim);">No active services found.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            licenses.forEach(lic => {
                const isRules = lic.mid && lic.mid.includes('rules');
                const isTickets = lic.mid && lic.mid.includes('ticket');
                const isBroadcast = lic.mid && lic.mid.includes('broadcast');

                let icon = 'bot';
                if (isRules) icon = 'scroll';
                if (isTickets) icon = 'ticket';
                if (isBroadcast) icon = 'megaphone';
                if (lic.module_name.toLowerCase().includes('system') || (lic.mid && (lic.mid.toLowerCase() === 'system' || lic.mid.toLowerCase() === 'system_bot' || lic.mid.toLowerCase() === 'broadcast_system'))) icon = 'cpu';

                const card = document.createElement('div');
                card.className = 'widget-card';
                card.style = 'padding: 24px; display: flex; align-items: center; justify-content: space-between; background: rgba(15, 15, 18, 0.6); border: 1px solid rgba(255,255,255,0.05);';
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 48px; height: 48px; border-radius: 12px; background: var(--surface-accent); display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="${icon}" style="width: 24px; color: var(--accent);"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 16px; font-weight: 700;">${lic.module_name}</h3>
                            <p style="font-size: 12px; color: var(--text-dim);">${isRules ? 'Rules Module' : isTickets ? 'Ticket System' : 'Automation Bot'}</p>
                        </div>
                    </div>
                    <div class="badge badge-active">Active</div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function addRule(title = '', emoji = '', text = '') {
            const container = document.getElementById('rulesContainer');
            const ruleId = 'rule_' + Date.now() + Math.random().toString(36).substr(2, 5);

            const div = document.createElement('div');
            div.id = ruleId;
            div.className = 'rule-card';
            div.style = 'background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 16px; padding: 20px;';

            div.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; margin-bottom: 16px; align-items: flex-end;">
                    <div>
                        <label style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 6px;">Section Title</label>
                        <input type="text" class="rule-title" value="${title}" placeholder="e.g. Qawwanin" style="width:100%; padding:8px 12px; background:var(--surface-accent); border:1px solid var(--border); border-radius:8px; color:white; font-size:14px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 6px;">Emoji</label>
                        <input type="text" class="rule-emoji" value="${emoji}" placeholder="ðŸ“œ" style="width:100%; padding:8px 12px; background:var(--surface-accent); border:1px solid var(--border); border-radius:8px; color:white; font-size:14px;">
                    </div>
                    <button onclick="this.closest('.rule-card').remove(); setDirty(true);" class="icon-btn btn-delete">
                        <i data-lucide="trash-2" style="width: 16px;"></i>
                    </button>
                </div>
                <div>
                    <label style="display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 6px;">Rules Content</label>
                    <textarea class="rule-text" rows="4" placeholder="Write rules for this section here..." style="width:100%; padding:10px; background:var(--surface-accent); border:1px solid var(--border); border-radius:8px; color:white; font-size:14px; resize: vertical;">${text}</textarea>
                </div>
            `;

            container.appendChild(div);
            lucide.createIcons();
            if (title === '' && !isDirty) setDirty(true); // Only trigger dirty if it's a manual add, not population
        }

        function addOption(name = '', emoji = '', desc = '') {
            const container = document.getElementById('optionsList');
            const div = document.createElement('div');
            div.className = 'option-row';
            div.style = 'display: flex; gap: 12px; align-items: center; background: rgba(255,255,255,0.02); padding: 12px; border-radius: 12px; border: 1px solid var(--border); animation: premiumPop 0.3s ease-out;';
            div.innerHTML = `
                <div style="flex: 1;">
                    <label style="display: block; font-size: 10px; color: var(--text-dim); margin-bottom: 4px;">Option Name</label>
                    <input type="text" class="cfg-option-name" value="${name}" placeholder="Support" style="width:100%; padding:8px 12px; background:var(--surface-accent); border:1px solid var(--border); border-radius:8px; color:white; font-size:13px;">
                </div>
                <div style="flex: 2;">
                    <label style="display: block; font-size: 10px; color: var(--text-dim); margin-bottom: 4px;">Description</label>
                    <input type="text" class="cfg-option-desc" value="${desc}" placeholder="Request Support" style="width:100%; padding:8px 12px; background:var(--surface-accent); border:1px solid var(--border); border-radius:8px; color:white; font-size:13px;">
                </div>
                <div style="width: 60px;">
                    <label style="display: block; font-size: 10px; color: var(--text-dim); margin-bottom: 4px;">Emoji</label>
                    <input type="text" class="cfg-option-emoji" value="${emoji}" placeholder="ðŸ›¡ï¸" style="width:100%; padding:8px 12px; background:var(--surface-accent); border:1px solid var(--border); border-radius:8px; color:white; font-size:13px; text-align: center;">
                </div>
                <button onclick="this.closest('.option-row').remove(); setDirty(true);" class="icon-btn btn-delete" style="margin-top: 18px;">
                    <i data-lucide="trash-2" style="width: 14px;"></i>
                </button>
            `;
            container.appendChild(div);
            lucide.createIcons();
            if (name === '' && !isDirty) setDirty(true);
        }

        function openResponderModal() {
            document.getElementById('responderModalOverlay').classList.add('active');
            document.getElementById('responderModal').classList.add('active');

            // Populate dropdowns in modal
            populateResponderDropdowns();

            // Clear fields if adding new
            document.getElementById('adv_responder_trigger').value = '';
            document.getElementById('adv_responder_wildcard').checked = false;
            document.getElementById('adv_responder_reply').checked = false;
            document.getElementById('adv_responder_response').value = '';
            document.getElementById('cfg_adv_enabled_roles').value = '';
            document.getElementById('cfg_adv_disabled_channels').value = '';

            // Reset dropdown triggers
            document.querySelectorAll('#responderModal .select-trigger span').forEach(s => s.textContent = 'Select ..');

            lucide.createIcons();
        }

        function closeResponderModal() {
            document.getElementById('responderModalOverlay').classList.remove('active');
            document.getElementById('responderModal').classList.remove('active');
        }

        function insertVariable(tag) {
            const textarea = document.getElementById('adv_responder_response');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + tag + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + tag.length, start + tag.length);
        }

        function populateResponderDropdowns() {
            const rolesList = document.getElementById('adv_enabled_roles_list');
            const channelsList = document.getElementById('adv_disabled_channels_list');

            // Clear lists
            rolesList.innerHTML = '';
            channelsList.innerHTML = '';

            // Use available server data from lastStatsData
            const select = document.getElementById('moduleSelect');
            if (!select) return;

            const selectedOpt = select.options[select.selectedIndex];
            // Use data-mid (string ID) to match window.lastStatsData.bots keys
            const botId = selectedOpt ? selectedOpt.getAttribute('data-mid') : select.value;

            const botData = window.lastStatsData?.bots?.[botId];

            // Add "Select .." option
            const noneRole = document.createElement('div');
            noneRole.className = 'option-item';
            noneRole.textContent = 'Select ..';
            noneRole.onclick = () => selectCustomOption('', 'Select ..', 'adv_enabled_roles');
            rolesList.appendChild(noneRole);

            const noneChannel = document.createElement('div');
            noneChannel.className = 'option-item';
            noneChannel.textContent = 'Select ..';
            noneChannel.onclick = () => selectCustomOption('', 'Select ..', 'adv_disabled_channels');
            channelsList.appendChild(noneChannel);

            if (botData && botData.servers) {
                let allChannels = [];
                let allRoles = [];
                botData.servers.forEach(srv => {
                    if (srv.channels) allChannels = allChannels.concat(srv.channels);
                    if (srv.roles) allRoles = allRoles.concat(srv.roles);
                });

                allRoles.forEach(role => {
                    const div = document.createElement('div');
                    div.className = 'option-item';
                    div.textContent = role.name;
                    div.onclick = () => selectCustomOption(role.id, role.name, 'adv_enabled_roles');
                    rolesList.appendChild(div);
                });

                allChannels.forEach(channel => {
                    const div = document.createElement('div');
                    div.className = 'option-item';
                    div.textContent = channel.name;
                    div.onclick = () => selectCustomOption(channel.id, channel.name, 'adv_disabled_channels');
                    channelsList.appendChild(div);
                });
            }
        }

        function saveAdvancedResponse() {
            const trigger = document.getElementById('adv_responder_trigger').value;
            const response = document.getElementById('adv_responder_response').value;
            const wildcard = document.getElementById('adv_responder_wildcard').checked;
            const reply = document.getElementById('adv_responder_reply').checked;
            const enabledRoles = document.getElementById('cfg_adv_enabled_roles').value;
            const disabledChannels = document.getElementById('cfg_adv_disabled_channels').value;

            if (!trigger || !response) {
                showToast('Please fill in both trigger and response.');
                return;
            }

            const responderData = {
                trigger,
                response,
                wildcard,
                reply,
                enabledRoles: enabledRoles ? enabledRoles.split(',') : [],
                disabledChannels: disabledChannels ? disabledChannels.split(',') : []
            };

            addResponderRowAdvanced(responderData);
            closeResponderModal();
            setDirty(true);
        }

        function addResponderRowAdvanced(data) {
            const container = document.getElementById('responder-list');
            const div = document.createElement('div');
            div.className = 'responder-entry';
            div.style.gridTemplateColumns = '1.2fr 2fr auto';

            const wildcardBadge = data.wildcard ? '<span style="background: rgba(59, 130, 246, 0.1); color: var(--accent); font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">Wildcard</span>' : '';

            div.innerHTML = `
                <div style="font-weight: 600; font-size: 14px; display: flex; align-items: center;">
                    ${data.trigger} ${wildcardBadge}
                </div>
                <div style="color: var(--text-dim); font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 300px;">
                    ${data.response}
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button onclick="this.parentElement.parentElement.remove(); setDirty(true);" class="icon-btn btn-delete" style="background: rgba(220, 38, 38, 0.1); border-color: rgba(220, 38, 38, 0.2); color: #ef4444;">
                        <i data-lucide="trash-2" style="width: 16px;"></i>
                    </button>
                    <input type="hidden" class="responder-data" value='${JSON.stringify(data).replace(/'/g, "&apos;")}'>
                </div>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        function getModuleMid(id) {
            if (!id) return null;
            if (isNaN(id)) return id; // Already string
            const found = window.currentLicenses ? window.currentLicenses.find(l => l.module_id == id) : null;
            return found ? found.mid : id;
        }

        function isSystemModule(mid) {
            if (!mid) return false;
            const s = String(mid).toLowerCase();
            return s === 'system' || s === 'system_bot' || s === 'broadcast_system' || s.includes('system') || s.includes('automod');
        }

        function isRulesModule(mid) {
            if (!mid) return false;
            return String(mid).toLowerCase().includes('rules');
        }

        function isTicketsModule(mid) {
            if (!mid) return false;
            return String(mid).toLowerCase().includes('ticket');
        }

        function isBroadcastModule(mid) {
            if (!mid) return false;
            return String(mid).toLowerCase().includes('broadcast');
        }

        function fillConfigForm(config) {
            config = config || {};
            const moduleId = document.getElementById('moduleSelect').value;
            const mid = getModuleMid(moduleId);
            const isRules = isRulesModule(mid);
            const isSystem = isSystemModule(mid);
            const isTickets = isTicketsModule(mid);
            const isBroadcast = isBroadcastModule(mid);
            const multiTokenArea = document.getElementById('multi_token_fields');
            const tokenLabel1 = document.getElementById('token_label_1');

            // Visibility control
            document.getElementById('ticketFields').style.display = isTickets ? 'grid' : 'none';
            document.getElementById('rulesFields').style.display = isRules ? 'grid' : 'none';
            document.getElementById('broadcastFields').style.display = isBroadcast ? 'grid' : 'none';

            const feedbackCard = document.getElementById('feedback_settings_card');
            if (feedbackCard) {
                feedbackCard.style.display = isTickets ? 'block' : 'none';
                if (isTickets) {
                    // Ensure it has high z-index when open
                    feedbackCard.style.zIndex = "10";
                }
            }

            // Disable deploy widget for broadcast as per request
            document.getElementById('deployEmbedWidget').style.display = (isRules || isTickets) ? 'block' : 'none';

            if (isBroadcast) {
                tokenLabel1.textContent = "Token 1 (Primary)";
                multiTokenArea.style.display = 'grid';
                let tokens = [];
                try {
                    const bt = config.bot_token;
                    if (Array.isArray(bt)) {
                        tokens = bt;
                    } else if (typeof bt === 'string' && bt.trim().startsWith('[')) {
                        tokens = JSON.parse(bt);
                    } else if (bt) {
                        tokens = [bt];
                    }
                } catch (e) {
                    console.error("Token parse error:", e);
                    tokens = [config.bot_token];
                }

                document.getElementById('cfg_bot_token').value = tokens[0] || '';
                document.getElementById('cfg_bot_token_2').value = tokens[1] || '';
                document.getElementById('cfg_bot_token_3').value = tokens[2] || '';
                document.getElementById('cfg_bot_token_4').value = tokens[3] || '';

                const allowed = config.allowed_users || [];
                document.getElementById('bc_allowed_users').value = allowed.join('\n');

            } else {
                tokenLabel1.textContent = "Discord Bot Token";
                multiTokenArea.style.display = 'none';
                document.getElementById('cfg_bot_token').value = config.bot_token || '';
            }

            if (isRules) {
                const e = config.embed || {};
                document.getElementById('rules_title').value = e.title || '';
                document.getElementById('rules_description').value = e.description || '';
                document.getElementById('rules_placeholder').value = config.menu_placeholder || '';
                document.getElementById('rules_footer').value = config.footer_text || '';
                document.getElementById('rules_color').value = e.color || '';
                document.getElementById('rules_thumbnail').value = e.thumbnail || '';
                document.getElementById('rules_image').value = e.image || '';

                // Populate dynamic rules
                const container = document.getElementById('rulesContainer');
                container.innerHTML = '';
                const rules = config.rules || {};
                const keys = Object.keys(rules);
                if (keys.length > 0) {
                    keys.forEach(key => {
                        addRule(key, rules[key].emoji || '', rules[key].text || '');
                    });
                } else {
                    addRule(); // Add one empty by default
                }
            } else if (isTickets) {
                document.getElementById('cfg_transcript_log_id').value = config.transcript_log_id || '';
                document.getElementById('cfg_feedback_channel_id').value = config.feedback_channel_id || '';
                document.getElementById('cfg_current_open_cat_id').value = config.current_open_cat_id || '';
                document.getElementById('cfg_current_closed_cat_id').value = config.current_closed_cat_id || '';
                document.getElementById('cfg_required_role_id').value = config.required_role_id || '';

                const method = config.feedback_method || '1';
                const methodLabels = {
                    '1': 'Option 1: Stars Buttons',
                    '2': 'Option 2: Detail Modal + GIF',
                    '3': 'Option 3: Professional Image'
                };
                selectFeedbackMethod(method, methodLabels[method] || methodLabels['1']);
                setDirty(false); // Reset dirty because selectFeedbackMethod triggers it

                document.getElementById('cfg_feedback_gif_url').value = config.feedback_gif_url || '';
                document.getElementById('cfg_fb_m2_prod_label').value = config.fb_m2_prod_label || '';
                document.getElementById('cfg_fb_m2_sell_label').value = config.fb_m2_sell_label || '';
                document.getElementById('cfg_fb_m2_rate_label').value = config.fb_m2_rate_label || '';
                document.getElementById('cfg_fb_m2_exp_label').value = config.fb_m2_exp_label || '';
                document.getElementById('cfg_fb_m3_bg_url').value = config.fb_m3_bg_url || '';

                const e = config.embed_settings || {};
                document.getElementById('cfg_embed_title').value = e.title || '';
                document.getElementById('cfg_embed_description').value = e.description || '';
                document.getElementById('cfg_thumbnail_url').value = e.thumbnail_url || '';
                document.getElementById('cfg_image_url').value = e.image_url || '';
                document.getElementById('cfg_embed_color').value = e.color || '';

                // Populate dynamic options
                const optionsContainer = document.getElementById('optionsList');
                optionsContainer.innerHTML = '';
                const options = config.ticket_options || config.options || []; // Support fallback
                if (options.length > 0) {
                    options.forEach(opt => {
                        if (typeof opt === 'string') {
                            // Fallback for old simple list
                            addOption(opt, 'ðŸŽ«');
                        } else {
                            addOption(opt.name || '', opt.emoji || '', opt.description || '');
                        }
                    });
                } else {
                    addOption('Support', 'ðŸ›¡ï¸', 'Request Support');
                }
                document.getElementById('ticket_menu_placeholder').value = config.menu_placeholder || '';
            } else if (isSystem) {
                // System Module Logic
                // Sync Master Toggles (Internal & Main)
                const masterToggles = ['moderation_enabled', 'automod_enabled', 'responder_enabled', 'auto_roles_enabled', 'logs_enabled'];
                masterToggles.forEach(id => {
                    const val = !!config[id];
                    const el = document.getElementById(id);
                    const mainEl = document.getElementById(id + '_main');
                    if (el) el.checked = val;
                    if (mainEl) mainEl.checked = val;
                });

                document.getElementById('cfg_auto_roles').value = config.cfg_auto_roles || '';
                document.getElementById('cfg_auto_roles_bots').value = config.cfg_auto_roles_bots || '';

                // Automod Logic
                const amFilters = ['spam', 'badwords', 'duplicate', 'invites', 'links', 'caps', 'emojispam', 'mentions'];
                amFilters.forEach(f => {
                    const el = document.getElementById(`am_${f}_enabled`);
                    if (el) el.checked = !!config[`am_${f}_enabled`];
                });

                const amExclusions = ['ignored_channels', 'ignored_roles', 'images_channels', 'youtube_channels'];
                amExclusions.forEach(ex => {
                    const input = document.getElementById(`cfg_am_${ex}`);
                    if (input) {
                        input.value = config[`am_${ex}`] || '';
                        updateDropdownDisplay(`am_${ex}`);
                    }
                });

                // Moderation Logic
                const modCommands = ['ban', 'unban', 'kick', 'timeout', 'untimeout', 'clear', 'lock', 'unlock'];
                modCommands.forEach(cmd => {
                    const el = document.getElementById(`mod_${cmd}_enabled`);
                    if (el) el.checked = !!config[`mod_${cmd}_enabled`];
                });

                // Auto Responder Logic
                document.getElementById('responder_enabled').checked = !!config.responder_enabled;
                const responderList = document.getElementById('responder-list');
                responderList.innerHTML = '';
                const responses = config.auto_responses || [];
                responses.forEach(r => addResponderRowAdvanced(r));

                // Sync Custom Select Trigger Text for System
                updateDropdownDisplay('auto_roles');
                updateDropdownDisplay('auto_roles_bots');

                // Populate Logs Grid if it's there
                if (typeof populateLogs === 'function') {
                    populateLogs();
                    const logs = config.logs || {};
                    logEvents.forEach(ev => {
                        const enabledCheck = document.getElementById(`log_${ev.id}_enabled`);
                        const channelInput = document.getElementById(`cfg_log_${ev.id}_channel`);
                        const colorInput = document.getElementById(`log_${ev.id}_color`);

                        if (enabledCheck) enabledCheck.checked = !!logs[ev.id]?.enabled;
                        if (channelInput) {
                            channelInput.value = logs[ev.id]?.channel || '';
                            updateDropdownDisplay(`log_${ev.id}_channel`);
                        }
                        if (colorInput) {
                            const color = logs[ev.id]?.color || '#000000';
                            colorInput.value = color;
                            colorInput.parentElement.style.background = color;
                        }
                    });
                }
            }
            document.getElementById('target_channel_id').value = config.send_target_channel || '';
        }

        async function saveModuleConfig() {
            try {
                const select = document.getElementById('moduleSelect');
                let moduleId = select.value;

                if (!moduleId && window.currentLicenses && window.currentLicenses.length === 1) {
                    moduleId = window.currentLicenses[0].module_id;
                }

                if (!moduleId) {
                    showToast("Error: No module selected");
                    return;
                }

                const selectedOpt = select.options[select.selectedIndex];
                const mid = selectedOpt ? selectedOpt.getAttribute('data-mid') : getModuleMid(moduleId);

                const isBroadcast = isBroadcastModule(mid);
                const isTickets = isTicketsModule(mid);
                const isRules = isRulesModule(mid);
                const isSystem = isSystemModule(mid);

                // Source of truth for config is the existing data plus DOM overrides
                let config = { ...(originalConfig || {}) };

                // Collect basic fields
                const tokens = (function () {
                    if (isBroadcast) {
                        const t1 = document.getElementById('cfg_bot_token')?.value || '';
                        const t2 = document.getElementById('cfg_bot_token_2')?.value || '';
                        const t3 = document.getElementById('cfg_bot_token_3')?.value || '';
                        const t4 = document.getElementById('cfg_bot_token_4')?.value || '';
                        return [t1, t2, t3, t4].filter(t => t.trim() !== '');
                    }
                    return [document.getElementById('cfg_bot_token')?.value || ''].filter(t => t.trim() !== '');
                })();

                config.bot_token = isBroadcast ? JSON.stringify(tokens) : (tokens[0] || '');
                config.send_target_channel = document.getElementById('target_channel_id')?.value || '';

                console.log("[Save] Initial config base:", config);


                // Collect module-specific fields
                if (isSystem) {
                    const logs = {};
                    if (typeof logEvents !== 'undefined') {
                        logEvents.forEach(ev => {
                            logs[ev.id] = {
                                enabled: document.getElementById(`log_${ev.id}_enabled`)?.checked || false,
                                channel: document.getElementById(`cfg_log_${ev.id}_channel`)?.value || '',
                                color: document.getElementById(`log_${ev.id}_color`)?.value || '#000000'
                            };
                        });
                    }

                    Object.assign(config, {
                        auto_roles_enabled: document.getElementById('auto_roles_enabled')?.checked || false,
                        cfg_auto_roles: document.getElementById('cfg_auto_roles')?.value || '',
                        cfg_auto_roles_bots: document.getElementById('cfg_auto_roles_bots')?.value || '',
                        moderation_enabled: document.getElementById('moderation_enabled')?.checked || false,
                        logs_enabled: document.getElementById('logs_enabled')?.checked || false,
                        logs: logs,
                        automod_enabled: document.getElementById('automod_enabled')?.checked || false,
                        am_spam_enabled: document.getElementById('am_spam_enabled')?.checked || false,
                        am_badwords_enabled: document.getElementById('am_badwords_enabled')?.checked || false,
                        am_duplicate_enabled: document.getElementById('am_duplicate_enabled')?.checked || false,
                        am_invites_enabled: document.getElementById('am_invites_enabled')?.checked || false,
                        am_links_enabled: document.getElementById('am_links_enabled')?.checked || false,
                        am_caps_enabled: document.getElementById('am_caps_enabled')?.checked || false,
                        am_emojispam_enabled: document.getElementById('am_emojispam_enabled')?.checked || false,
                        am_mentions_enabled: document.getElementById('am_mentions_enabled')?.checked || false,
                        am_ignored_channels: document.getElementById('cfg_am_ignored_channels')?.value || '',
                        am_ignored_roles: document.getElementById('cfg_am_ignored_roles')?.value || '',
                        am_images_channels: document.getElementById('cfg_am_images_channels')?.value || '',
                        am_youtube_channels: document.getElementById('cfg_am_youtube_channels')?.value || '',
                        mod_ban_enabled: document.getElementById('mod_ban_enabled')?.checked || false,
                        mod_unban_enabled: document.getElementById('mod_unban_enabled')?.checked || false,
                        mod_kick_enabled: document.getElementById('mod_kick_enabled')?.checked || false,
                        mod_timeout_enabled: document.getElementById('mod_timeout_enabled')?.checked || false,
                        mod_untimeout_enabled: document.getElementById('mod_untimeout_enabled')?.checked || false,
                        mod_clear_enabled: document.getElementById('mod_clear_enabled')?.checked || false,
                        mod_lock_enabled: document.getElementById('mod_lock_enabled')?.checked || false,
                        mod_unlock_enabled: document.getElementById('mod_unlock_enabled')?.checked || false,
                        responder_enabled: document.getElementById('responder_enabled')?.checked || false,
                        auto_responses: Array.from(document.querySelectorAll('.responder-entry'))
                            .map(row => JSON.parse(row.querySelector('.responder-data').value))
                            .filter(r => r.trigger !== '')
                    });
                } else if (isBroadcast) {
                    config.allowed_users = document.getElementById('bc_allowed_users')?.value.split('\n').map(u => u.trim()).filter(u => u !== '') || [];
                } else if (isRules) {
                    const rulesObj = {};
                    document.querySelectorAll('.rule-card').forEach(card => {
                        const rTitle = card.querySelector('.rule-title')?.value.trim();
                        const rEmoji = card.querySelector('.rule-emoji')?.value.trim() || '';
                        const rText = card.querySelector('.rule-text')?.value.trim() || '';
                        if (rTitle) {
                            rulesObj[rTitle] = { emoji: rEmoji, text: rText };
                        }
                    });

                    config.embed = {
                        title: document.getElementById('rules_title')?.value || '',
                        description: document.getElementById('rules_description')?.value || '',
                        color: document.getElementById('rules_color')?.value || '',
                        thumbnail: document.getElementById('rules_thumbnail')?.value || '',
                        image: document.getElementById('rules_image')?.value || ''
                    };
                    config.menu_placeholder = document.getElementById('rules_placeholder')?.value || '';
                    config.footer_text = document.getElementById('rules_footer')?.value || '';
                    config.rules = rulesObj;
                } else {
                    // Default to Tickets
                    Object.assign(config, {
                        transcript_log_id: document.getElementById('cfg_transcript_log_id')?.value || '',
                        feedback_channel_id: document.getElementById('cfg_feedback_channel_id')?.value || '',
                        current_open_cat_id: document.getElementById('cfg_current_open_cat_id')?.value || '',
                        current_closed_cat_id: document.getElementById('cfg_current_closed_cat_id')?.value || '',
                        required_role_id: document.getElementById('cfg_required_role_id')?.value || '',
                        feedback_method: document.getElementById('cfg_feedback_method')?.value || '1',
                        feedback_gif_url: document.getElementById('cfg_feedback_gif_url')?.value || '',
                        fb_m2_prod_label: document.getElementById('cfg_fb_m2_prod_label')?.value || '',
                        fb_m2_sell_label: document.getElementById('cfg_fb_m2_sell_label')?.value || '',
                        fb_m2_rate_label: document.getElementById('cfg_fb_m2_rate_label')?.value || '',
                        fb_m2_exp_label: document.getElementById('cfg_fb_m2_exp_label')?.value || '',
                        fb_m3_bg_url: document.getElementById('cfg_fb_m3_bg_url')?.value || '',
                        embed_settings: {
                            title: document.getElementById('cfg_embed_title')?.value || '',
                            description: document.getElementById('cfg_embed_description')?.value || '',
                            thumbnail_url: document.getElementById('cfg_thumbnail_url')?.value || '',
                            image_url: document.getElementById('cfg_image_url')?.value || '',
                            color: document.getElementById('cfg_embed_color')?.value || ''
                        },
                        ticket_options: Array.from(document.querySelectorAll('.option-row'))
                            .map(row => ({
                                name: row.querySelector('.cfg-option-name')?.value.trim() || '',
                                description: row.querySelector('.cfg-option-desc')?.value.trim() || '',
                                emoji: row.querySelector('.cfg-option-emoji')?.value.trim() || '',
                                value: 'ticket_' + (row.querySelector('.cfg-option-name')?.value.trim().replace(/\s+/g, '_') || '')
                            }))
                            .filter(opt => opt.name !== ''),
                        menu_placeholder: document.getElementById('ticket_menu_placeholder')?.value.trim() || ''
                    });
                }

                console.log("Saving Configuration:", { moduleId, mid, config });

                console.log("[Save] Final config to send:", config);
                const data = await apiFetch('/api/modules/update_config', {
                    module_id: moduleId,
                    config: config
                });

                if (data && data.success) {
                    showToast("Settings saved successfully!");
                    setDirty(false);
                    loadModuleConfig();
                } else {
                    showToast("Error: " + (data?.error || "Unknown error"));
                }
            } catch (e) {
                console.error("Save Error:", e);
                showToast("JS Error: " + e.message);
            }
        }

        async function sendEmbed() {
            const channelLink = document.getElementById('target_channel_id').value;
            if (!channelLink) return showToast("Please enter a Target Channel Link");

            const moduleId = document.getElementById('moduleSelect').value;
            if (!moduleId) return showToast("Please select a module first");

            const btn = document.querySelector('#deployEmbedWidget .btn-master');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="animate-spin" data-lucide="loader-2"></i> Triggering Bot...';
                lucide.createIcons();

                const data = await apiFetch('/api/modules/edit', {
                    module_id: moduleId,
                    config_update: {
                        trigger_send_embed: Date.now(), // Unique ID for this trigger
                        send_target_channel: channelLink
                    }
                });

                if (data && data.success) {
                    showToast("Trigger sent! Bot will sync in ~10s");
                } else if (data) {
                    showToast(data.error || "Failed to send request");
                }
            } catch (e) {
                showToast("Network error");
            } finally {
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    lucide.createIcons();
                }, 3000);
            }
        }

        function renderClientView(data, isAuto = false) {
            window.lastStatsData = data; // Store for dynamic population
            // Update stats
            // Stats updated via fetchPublicStats() now
            // document.getElementById('stat-global-users').textContent = (data.total_admins || 0).toLocaleString();
            // document.getElementById('stat-licenses-issued').textContent = (data.raw_licenses.length || 0).toLocaleString();

            // Populate module selector (only re-init config if not auto-refresh)
            populateModules(data, isAuto);

            // Render dynamic active services
            renderActiveServices(window.currentLicenses);

            // Populate Dropdowns with Server Data
            populateAutomodDropdowns();

            lucide.createIcons();
        }


        function discardChanges() {
            if (originalConfig) {
                showConfirm("Reset All Changes", "Are you sure you want to discard your unsaved changes and revert to the last saved state?", () => {
                    fillConfigForm(originalConfig);
                    setDirty(false);
                });
            }
        }

        // Add input listeners to the whole container to detect changes
        document.addEventListener('input', (e) => {
            // IGNORE channel link input from dirty state logic
            if (e.target.id === 'target_channel_id') return;

            const configContainer = document.getElementById('configContainer');
            if (configContainer && configContainer.contains(e.target)) {
                if (!isDirty) setDirty(true);
            }
        });

        window.onbeforeunload = function (e) {
            if (isDirty) {
                return "You have unsaved changes. Are you sure you want to leave?";
            }
        };

        // Custom Select Logic for Feedback
        document.addEventListener('click', (e) => {
            const selects = document.querySelectorAll('.custom-select');
            selects.forEach(select => {
                if (!select.contains(e.target)) {
                    select.classList.remove('active');
                }
            });
        });

        function toggleCustomSelect(el) {
            el.closest('.custom-select').classList.toggle('active');
        }

        function selectFeedbackMethod(val, label) {
            const container = document.getElementById('select_feedback_method_container');
            const triggerText = container.querySelector('.select-trigger span');
            const hiddenInput = document.getElementById('cfg_feedback_method');

            triggerText.textContent = label;
            hiddenInput.value = val;

            container.querySelectorAll('.option-item').forEach(opt => {
                opt.classList.toggle('selected', opt.getAttribute('data-value') == val);
            });

            container.classList.remove('active');

            // Show/Hide extra fields
            document.getElementById('method2_extras').style.display = (val === '2') ? 'block' : 'none';
            document.getElementById('method3_extras').style.display = (val === '3') ? 'block' : 'none';

            if (!isDirty) setDirty(true);
        }

        function selectOption(val, label, type) {
            const container = document.getElementById(`select_${type}_container`);
            const triggerText = container.querySelector('.select-trigger span');
            const hiddenInput = document.getElementById((type === 'rating' || type === 'module') ? `feedback_${type}_value` : `cfg_${type}`);

            triggerText.textContent = label;
            hiddenInput.value = val;

            container.querySelectorAll('.option-item').forEach(opt => {
                opt.classList.toggle('selected', opt.getAttribute('data-value') == val);
            });

            container.classList.remove('active');
            if (type !== 'rating' && type !== 'module') {
                if (!isDirty) setDirty(true);
            }
        }

        function selectCustomOption(val, label, type) {
            selectOption(val, label, type);
        }

        function filterDropdownOptions(input) {
            const container = input.closest('.select-options');
            const term = input.value.toLowerCase();
            const items = container.querySelectorAll('.option-item');

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        // Feedback Modal Functions
        function openFeedbackModal() {
            populateFeedbackModules();
            document.getElementById('feedbackModal').classList.add('active');
        }

        function populateFeedbackModules() {
            const container = document.getElementById('select_module_options');
            const hiddenInput = document.getElementById('feedback_module_value');
            const triggerText = document.querySelector('#select_module_container .select-trigger span');

            container.innerHTML = '';

            // Add "Custom Bot" option (renamed from General Feedback)
            const generalOpt = document.createElement('div');
            generalOpt.className = 'option-item selected';
            generalOpt.setAttribute('data-value', '0');
            generalOpt.textContent = 'Custom Bot';
            generalOpt.onclick = () => selectOption(0, 'Custom Bot', 'module');
            container.appendChild(generalOpt);

            // Use allAvailableModules if available (populated from stats)
            const modulesToShow = window.allAvailableModules || [];

            if (modulesToShow.length > 0) {
                modulesToShow.forEach(mod => {
                    const opt = document.createElement('div');
                    opt.className = 'option-item';
                    opt.setAttribute('data-value', mod.id);
                    opt.textContent = mod.name || `Bot #${mod.id}`;
                    opt.onclick = () => selectOption(mod.id, mod.name, 'module');
                    container.appendChild(opt);
                });
            } else {
                // If no modules fetched, ensure "Custom Bot" is the only option and selected
                triggerText.textContent = 'Custom Bot';
                hiddenInput.value = '0';
            }

            // Reset to Custom Bot by default
            selectOption(0, 'Custom Bot', 'module');
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('active');
        }

        async function submitFeedback(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('feedbackSubmitBtn');
            const ratingInput = document.getElementById('feedback_rating_value');

            if (!ratingInput.value) {
                showError('Please select a rating');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Submitting...';

            try {
                const res = await fetch('/api/public/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: form.message.value,
                        rating: parseInt(document.getElementById('feedback_rating_value').value),
                        module_id: parseInt(document.getElementById('feedback_module_value').value)
                    })
                });

                const data = await res.json();

                if (data.success) {
                    showSuccess("Feedback submitted successfully!");
                    closeFeedbackModal();
                    form.reset();
                } else {
                    showError(data.error || "Failed to submit feedback. You may have already submitted one.");
                }
            } catch (e) {
                showError('Error submitting feedback');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit Feedback';
            }
        }

        async function fetchPublicStats() {
            try {
                const res = await fetch('/api/public/stats');
                const data = await res.json();
                if (data.success) {
                    const u = document.getElementById('stat-global-users');
                    if (u) u.textContent = (data.total_clients || 0).toLocaleString();

                    const l = document.getElementById('stat-licenses-issued');
                    if (l) l.textContent = (data.active_licenses || 0).toLocaleString();

                    const m = document.getElementById('stat-modules-sold');
                    if (m) m.textContent = (data.modules_sold || 0).toLocaleString();
                }
            } catch (e) { console.error("Stats error", e); }
        }



        // Initial fetch and periodic update
        function showSystemMenu() {
            document.getElementById('system-options-container').style.display = 'block';
            document.getElementById('system-form-container').style.display = 'none';
            document.getElementById('system-setup-main-title').innerHTML = `<i data-lucide="ticket" style="color:var(--accent); width: 20px;"></i> Tickets System Setup`;

            // Unselect sidebar children
            document.querySelectorAll('.nav-item.sub').forEach(item => item.classList.remove('active'));
            lucide.createIcons();
        }

        function selectSetupOption(option, el) {
            // UI effect in sidebar if el is provided
            if (el) {
                document.querySelectorAll('.nav-item.sub').forEach(item => item.classList.remove('active'));
                el.classList.add('active');
            }

            // Show System Setup View if not already visible
            const sysView = document.getElementById('systemSetupView');
            if (sysView.style.display === 'none') {
                switchView('system_setup', document.getElementById('nav-system-setup'));
            }

            // Show Form Container
            document.getElementById('system-options-container').style.display = 'none';
            document.getElementById('system-form-container').style.display = 'block';

            // Hide all forms first
            document.querySelectorAll('.system-form').forEach(f => f.style.display = 'none');

            // Find and show target form - map names if necessary
            let formId = 'form-' + option.replace(/\s+/g, '');
            const targetForm = document.getElementById(formId);

            if (targetForm) {
                targetForm.style.display = 'block';
            } else {
                document.getElementById('form-unimplemented').style.display = 'block';
            }

            // Update Page Title
            const titleMap = {
                'Roles': 'Auto Roles',
                'Welcome': 'Welcome & Goodbye',
                'Responder': 'Auto Responder',
                'Leveling': 'Leveling System'
            };
            document.getElementById('system-setup-main-title').textContent = titleMap[option] || option;

            if (option === 'Logs') {
                populateLogs();
            }

            if (option === 'Automod') {
                populateAutomodDropdowns();
            }

            // Sync with central menu icons if visible
            document.querySelectorAll('.setup-item').forEach(item => {
                item.classList.remove('active');
                const span = item.querySelector('span');
                if (span && (span.textContent === option || (option === 'Welcome' && span.textContent === 'Welcome & Goodbye') || (option === 'Roles' && span.textContent === 'Auto Roles'))) {
                    item.classList.add('active');
                }
            });

            lucide.createIcons();
        }

        // Synchronize toggles between main menu and internal forms
        function syncToggle(targetId, checked) {
            const targetToggle = document.getElementById(targetId);
            if (targetToggle) {
                targetToggle.checked = checked;
                setDirty(true);
            }

            // Also sync back from internal to main if needed
            const mainId = targetId + '_main';
            const mainToggle = document.getElementById(mainId);
            if (mainToggle && mainToggle.checked !== checked) {
                mainToggle.checked = checked;
            }
        }

        function toggleCustomSelect(el) {
            const container = el.closest('.custom-select');
            const isActive = container.classList.contains('active');

            // Clean up state
            document.querySelectorAll('.custom-select').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.log-card, .widget-card').forEach(c => c.style.zIndex = 'auto');

            if (!isActive) {
                container.classList.add('active');
                // Raise the parent container's z-index to ensure dropdown is on top
                const parent = container.closest('.log-card') || container.closest('.widget-card');
                if (parent) parent.style.zIndex = '999';
            }
        }

        function selectCustomOption(val, text, inputId) {
            const input = document.getElementById('cfg_' + inputId) || document.getElementById(inputId);
            const container = document.getElementById('select_' + inputId + '_container');
            if (!input || !container) return;

            let currentValues = input.value ? input.value.split(',').filter(x => x) : [];

            // Check if this container is for a multi-select field (most Automod/Logs fields are)
            const isMulti = inputId.includes('ignored') || inputId.includes('disabled') || inputId.includes('channels') || inputId.includes('roles');

            if (isMulti) {
                if (val === '') {
                    currentValues = [];
                } else if (currentValues.includes(val)) {
                    currentValues = currentValues.filter(v => v !== val);
                } else {
                    currentValues.push(val);
                }
                input.value = currentValues.join(',');
            } else {
                input.value = val;
                currentValues = val ? [val] : [];
                container.classList.remove('active');
                const parent = container.closest('.log-card') || container.closest('.widget-card');
                if (parent) parent.style.zIndex = 'auto';
            }

            // Update display
            const triggerSpan = container.querySelector('.select-trigger span');
            if (currentValues.length === 0) {
                triggerSpan.textContent = "Select ..";
            } else if (currentValues.length === 1) {
                // Find selected option text for better display
                const selectedOpt = container.querySelector(`.option-item[data-value="${currentValues[0]}"]`);
                triggerSpan.textContent = selectedOpt ? selectedOpt.textContent : currentValues[0];
            } else {
                triggerSpan.textContent = `${currentValues.length} Selected`;
            }

            // Mark checkboxes/visuals in dropdown
            container.querySelectorAll('.option-item').forEach(opt => {
                const optVal = opt.getAttribute('data-value');
                if (optVal && currentValues.includes(optVal)) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });

            setDirty(true);
        }

        function updateDropdownDisplay(inputId) {
            const input = document.getElementById('cfg_' + inputId) || document.getElementById(inputId);
            const container = document.getElementById('select_' + inputId + '_container');
            if (!input || !container) return;

            const values = input.value ? input.value.split(',').filter(x => x) : [];
            const triggerSpan = container.querySelector('.select-trigger span');

            if (values.length === 0) {
                triggerSpan.textContent = "Select ..";
            } else if (values.length === 1) {
                const selectedOpt = container.querySelector(`.option-item[data-value="${values[0]}"]`);
                triggerSpan.textContent = selectedOpt ? selectedOpt.textContent : values[0];
            } else {
                triggerSpan.textContent = `${values.length} Selected`;
            }

            // Sync visuals
            container.querySelectorAll('.option-item').forEach(opt => {
                const optVal = opt.getAttribute('data-value');
                if (optVal && values.includes(optVal)) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
        }

        function filterDropdownOptions(el) {
            const search = el.value.toLowerCase();
            const optionsList = el.parentElement.querySelector('.options-list');
            if (!optionsList) return;

            optionsList.querySelectorAll('.option-item').forEach(opt => {
                const text = opt.textContent.toLowerCase();
                opt.style.display = (text.includes(search) || opt.getAttribute('data-value') === '') ? 'block' : 'none';
            });
        }

        // Moderation Modal Functions
        let currentModerationCommand = '';

        function openModerationModal(commandName) {
            currentModerationCommand = commandName;
            const modal = document.getElementById('moderationModal');
            const overlay = document.getElementById('moderationModalOverlay');

            // Set title and description
            const commandInfo = {
                'ban': { title: '/ban', desc: 'Bans a member.' },
                'unban': { title: '/unban', desc: 'Unbans a member.' },
                'kick': { title: '/kick', desc: 'Kicks a member.' },
                'timeout': { title: '/timeout', desc: 'Timeouts a member.' },
                'untimeout': { title: '/untimeout', desc: 'Removes a timeout from a member.' },
                'clear': { title: '/clear', desc: 'Cleans up channel messages.' },
                'lock': { title: '/lock', desc: 'Disables @everyone from sending messages in specific channel.' },
                'unlock': { title: '/unlock', desc: 'Allows @everyone to send messages in specific channel.' }
            };

            document.getElementById('moderation-modal-title').textContent = commandInfo[commandName].title;
            document.getElementById('moderation-modal-desc').textContent = commandInfo[commandName].desc;

            // Show/hide fields based on command type (from user's images)
            // Ban, Clear, Lock, Unlock: shows Disabled Channels
            // Timeout: shows Disabled Channels + timeout options
            // Unban, Kick, Untimeout: NO Disabled Channels, NO command-specific options

            const disabledChannelsDiv = document.querySelector('#select_mod_disabled_channels_container').parentElement;

            if (commandName === 'ban') {
                // Show everything
                disabledChannelsDiv.style.display = 'block';
                document.getElementById('mod-ban-options').style.display = 'block';
                document.getElementById('mod-timeout-options').style.display = 'none';
            } else if (commandName === 'timeout') {
                // Show disabled channels and timeout options
                disabledChannelsDiv.style.display = 'block';
                document.getElementById('mod-ban-options').style.display = 'none';
                document.getElementById('mod-timeout-options').style.display = 'block';
            } else if (commandName === 'clear' || commandName === 'lock' || commandName === 'unlock') {
                // Show disabled channels but no command-specific options
                disabledChannelsDiv.style.display = 'block';
                document.getElementById('mod-ban-options').style.display = 'none';
                document.getElementById('mod-timeout-options').style.display = 'none';
            } else {
                // unban, kick, untimeout - hide disabled channels and all options
                disabledChannelsDiv.style.display = 'none';
                document.getElementById('mod-ban-options').style.display = 'none';
                document.getElementById('mod-timeout-options').style.display = 'none';
            }

            // Populate dropdowns
            populateModerationDropdowns();

            // Load existing config if available
            loadModerationConfig(commandName);

            modal.classList.add('active');
            overlay.classList.add('active');
            lucide.createIcons();
        }

        function closeModerationModal() {
            document.getElementById('moderationModal').classList.remove('active');
            document.getElementById('moderationModalOverlay').classList.remove('active');
        }

        function populateModerationDropdowns() {
            // Note: Roles and channels will be populated when guild data is available
            // For now, dropdowns will be empty but functional
            // TODO: Integrate with existing guild data loading mechanism
        }

        function selectModerationOption(field, value) {
            if (field === 'delete_history') {
                document.getElementById('mod_ban_delete_history').value = value;
                document.getElementById('mod_ban_delete_history_display').textContent = value;
            } else if (field === 'time_action') {
                document.getElementById('mod_ban_time_action').value = value;
                document.getElementById('mod_ban_time_action_display').textContent = value;
            } else if (field === 'time_unit') {
                document.getElementById('mod_ban_time_unit').value = value;
                document.getElementById('mod_ban_time_unit_display').textContent = value;
            } else if (field === 'timeout_action') {
                document.getElementById('mod_timeout_time_action').value = value;
                document.getElementById('mod_timeout_time_action_display').textContent = value;
            } else if (field === 'timeout_unit') {
                document.getElementById('mod_timeout_time_unit').value = value;
                document.getElementById('mod_timeout_time_unit_display').textContent = value;
            }
            document.querySelectorAll('.custom-select').forEach(c => c.classList.remove('active'));
        }

        function loadModerationConfig(commandName) {
            // Load from current config if available
            const config = originalConfig || {};
            const cmdConfig = config[`mod_${commandName}_config`] || {};

            document.getElementById('mod_aliases').value = cmdConfig.aliases || '';
            document.getElementById('cfg_mod_enabled_roles').value = (cmdConfig.enabled_roles || []).join(',');
            document.getElementById('cfg_mod_disabled_roles').value = (cmdConfig.disabled_roles || []).join(',');
            document.getElementById('cfg_mod_enabled_channels').value = (cmdConfig.enabled_channels || []).join(',');
            document.getElementById('cfg_mod_disabled_channels').value = (cmdConfig.disabled_channels || []).join(',');

            updateDropdownDisplay('mod_enabled_roles');
            updateDropdownDisplay('mod_disabled_roles');
            updateDropdownDisplay('mod_enabled_channels');
            updateDropdownDisplay('mod_disabled_channels');
            document.getElementById('mod_auto_delete_message').checked = cmdConfig.auto_delete_message || false;
            document.getElementById('mod_auto_delete_command').checked = cmdConfig.auto_delete_command || false;
            document.getElementById('mod_auto_delete_reply').checked = cmdConfig.auto_delete_reply || false;

            if (commandName === 'ban') {
                document.getElementById('mod_ban_delete_history').value = cmdConfig.delete_history || 'None';
                document.getElementById('mod_ban_delete_history_display').textContent = cmdConfig.delete_history || 'None';
                document.getElementById('mod_ban_time_action').value = cmdConfig.time_action || 'ban for specific time';
                document.getElementById('mod_ban_time_action_display').textContent = cmdConfig.time_action || 'ban for specific time';
                document.getElementById('mod_ban_time_value').value = cmdConfig.time_value || '';
                document.getElementById('mod_ban_time_unit').value = cmdConfig.time_unit || 'Minutes';
                document.getElementById('mod_ban_time_unit_display').textContent = cmdConfig.time_unit || 'Minutes';
            } else if (commandName === 'timeout') {
                document.getElementById('mod_timeout_time_value').value = cmdConfig.time_value || '';
                document.getElementById('mod_timeout_time_unit').value = cmdConfig.time_unit || 'Minutes';
                document.getElementById('mod_timeout_time_unit_display').textContent = cmdConfig.time_unit || 'Minutes';
            }
        }

        function saveModerationConfig() {
            const config = {
                aliases: document.getElementById('mod_aliases').value,
                enabled_roles: document.getElementById('cfg_mod_enabled_roles').value.split(',').filter(x => x),
                disabled_roles: document.getElementById('cfg_mod_disabled_roles').value.split(',').filter(x => x),
                enabled_channels: document.getElementById('cfg_mod_enabled_channels').value.split(',').filter(x => x),
                disabled_channels: document.getElementById('cfg_mod_disabled_channels').value.split(',').filter(x => x),
                auto_delete_message: document.getElementById('mod_auto_delete_message').checked,
                auto_delete_command: document.getElementById('mod_auto_delete_command').checked,
                auto_delete_reply: document.getElementById('mod_auto_delete_reply').checked
            };

            if (currentModerationCommand === 'ban') {
                config.delete_history = document.getElementById('mod_ban_delete_history').value;
                config.time_action = document.getElementById('mod_ban_time_action').value;
                config.time_value = document.getElementById('mod_ban_time_value').value;
                config.time_unit = document.getElementById('mod_ban_time_unit').value;
            } else if (currentModerationCommand === 'timeout') {
                config.time_value = document.getElementById('mod_timeout_time_value').value;
                config.time_unit = document.getElementById('mod_timeout_time_unit').value;
            }

            // Save to form hidden input or directly to config
            const configKey = `mod_${currentModerationCommand}_config`;
            if (!originalConfig) originalConfig = {};
            originalConfig[configKey] = config;

            setDirty(true);
            closeModerationModal();
            showToast(`${currentModerationCommand} configuration updated!`);
        }

        // Automod Filter Modal Functions
        let currentAutomodFilter = '';

        function openAutomodModal(filterName) {
            currentAutomodFilter = filterName;
            const modal = document.getElementById('automodModal');
            const overlay = document.getElementById('automodModalOverlay');

            // Set title
            const filterTitles = {
                'spam': 'SPAM',
                'badwords': 'BAD WORDS',
                'duplicate': 'DUPLICATED TEXT',
                'links': 'LINKS'
            };

            document.getElementById('automod-modal-title').textContent = filterTitles[filterName];

            // Show/hide filter-specific options
            document.getElementById('automod-spam-options').style.display = filterName === 'spam' ? 'block' : 'none';
            document.getElementById('automod-badwords-options').style.display = filterName === 'badwords' ? 'block' : 'none';
            document.getElementById('automod-links-options').style.display = filterName === 'links' ? 'block' : 'none';

            // Hide Timeout option for Bad Words (as shown in image)
            const timeoutOption = document.getElementById('automod-timeout-option');
            if (timeoutOption) {
                timeoutOption.style.display = filterName === 'badwords' ? 'none' : 'flex';
            }

            // Load existing config if available
            loadAutomodConfig(filterName);

            modal.classList.add('active');
            overlay.classList.add('active');
            lucide.createIcons();
        }

        function closeAutomodModal() {
            document.getElementById('automodModal').classList.remove('active');
            document.getElementById('automodModalOverlay').classList.remove('active');
        }

        function loadAutomodConfig(filterName) {
            // Load from current config if available
            const config = originalConfig || {};
            const filterConfig = config[`automod_${filterName}_config`] || {};

            // Set response type
            const responseType = filterConfig.response || 'block';
            document.querySelector(`input[name="automod_response"][value="${responseType}"]`).checked = true;

            document.getElementById('cfg_automod_disabled_channels').value = (filterConfig.disabled_channels || []).join(',');
            document.getElementById('cfg_automod_disabled_roles').value = (filterConfig.disabled_roles || []).join(',');

            updateDropdownDisplay('automod_disabled_channels');
            updateDropdownDisplay('automod_disabled_roles');

            if (filterName === 'spam') {
                document.getElementById('automod_spam_threshold').value = filterConfig.threshold || 5;
            } else if (filterName === 'badwords') {
                document.getElementById('automod_badwords_list').value = (filterConfig.words || []).join(', ');
                document.getElementById('automod_badwords_partial').checked = filterConfig.partial_match || false;
            } else if (filterName === 'links') {
                document.getElementById('automod_whitelist_urls').value = (filterConfig.whitelist || []).join(', ');
                document.getElementById('automod_blacklist_links').value = (filterConfig.blacklist || []).join(', ');
            }
        }

        function saveAutomodConfig() {
            const responseType = document.querySelector('input[name="automod_response"]:checked').value;

            const config = {
                response: responseType,
                disabled_channels: document.getElementById('cfg_automod_disabled_channels').value.split(',').filter(x => x),
                disabled_roles: document.getElementById('cfg_automod_disabled_roles').value.split(',').filter(x => x)
            };

            if (currentAutomodFilter === 'spam') {
                config.threshold = parseInt(document.getElementById('automod_spam_threshold').value) || 5;
            } else if (currentAutomodFilter === 'badwords') {
                config.words = document.getElementById('automod_badwords_list').value.split(',').map(w => w.trim()).filter(w => w);
                config.partial_match = document.getElementById('automod_badwords_partial').checked;
            } else if (currentAutomodFilter === 'links') {
                config.whitelist = document.getElementById('automod_whitelist_urls').value.split(',').map(u => u.trim()).filter(u => u);
                config.blacklist = document.getElementById('automod_blacklist_links').value.split(',').map(l => l.trim()).filter(l => l);
            }

            // Save to config
            const configKey = `automod_${currentAutomodFilter}_config`;
            if (!originalConfig) originalConfig = {};
            originalConfig[configKey] = config;

            setDirty(true);
            closeAutomodModal();
            showToast(`${currentAutomodFilter} filter configured!`);
        }

        const logEvents = [
            { id: 'member_banned', name: 'Member Banned' },
            { id: 'timeout', name: 'Timeout (Given / Removed)' },
            { id: 'channel_created', name: 'Channel Created' },
            { id: 'thread_created', name: 'Thread Created' },
            { id: 'role_created', name: 'Role Created' },
            { id: 'channel_deleted', name: 'Channel Deleted' },
            { id: 'thread_deleted', name: 'Thread Deleted' },
            { id: 'message_deleted', name: 'Message Deleted' },
            { id: 'role_deleted', name: 'Role Deleted' },
            { id: 'message_edited', name: 'Message Edited' },
            { id: 'member_kicked', name: 'Member Kicked' },
            { id: 'member_moved_voice', name: 'Member moved voice' },
            { id: 'member_joined', name: 'Member Joined' },
            { id: 'member_left', name: 'Member Left' },
            { id: 'nickname_changed', name: 'Nickname Changed' },
            { id: 'mod_cmd_used', name: 'Moderation Command Used' },
            { id: 'role_given', name: 'Role Given' },
            { id: 'role_removed', name: 'Role Removed' },
            { id: 'server_invites', name: 'Server Invites' },
            { id: 'member_unbanned', name: 'Member Unbanned' },
            { id: 'channel_updated', name: 'Channel Updated' },
            { id: 'thread_updated', name: 'Thread Updated' },
            { id: 'channel_perms_updated', name: 'Channel Perms Updated' },
            { id: 'role_updated', name: 'Role Updated' },
            { id: 'server_updated', name: 'Update Server' },
            { id: 'voice_joined', name: 'Member Joined Voice' },
            { id: 'voice_left', name: 'Member Left Voice' },
            { id: 'voice_state', name: 'Voice State (Mute/Deafen)' },
            { id: 'voice_switched', name: 'Member Switched Voice' },
            { id: 'voice_disconnect', name: 'Member disconnected voice' }
        ];

        function populateLogs() {
            const grid = document.getElementById('logs-grid');
            if (grid.children.length > 0) return;

            // Load existing logs config
            let currentLogs = {};
            if (originalConfig && originalConfig.logs) {
                currentLogs = originalConfig.logs;
                if (typeof currentLogs === 'string') {
                    try { currentLogs = JSON.parse(currentLogs); } catch (e) { currentLogs = {}; }
                }
            }

            grid.innerHTML = logEvents.map(ev => {
                const cfg = currentLogs[ev.id] || {};
                const isEnabled = cfg.enabled === true || cfg.enabled === "true" || cfg.enabled === 1 || cfg.enabled === "on";
                const channelId = cfg.channel || "";
                const color = cfg.color || "#000000";

                return `
                <div class="log-card">
                    <div class="log-card-header">
                        <span class="log-card-title">
                            ${ev.name} ${ev.premium ? '<span class="tier-badge">Premium Tier 2</span>' : ''}
                        </span>
                        <label class="switch">
                            <input type="checkbox" id="log_${ev.id}_enabled" ${isEnabled ? 'checked' : ''} onchange="setDirty(true)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    
                    <div class="custom-select" id="select_log_${ev.id}_channel_container">
                        <input type="hidden" id="cfg_log_${ev.id}_channel" value="${channelId}">
                        <div class="select-trigger" onclick="toggleCustomSelect(this)">
                            <span>Select ..</span>
                            <i data-lucide="chevron-down" style="width: 14px;"></i>
                        </div>
                        <div class="select-options" style="max-height: 200px;">
                            <input type="text" class="dropdown-search" placeholder="Search channels..." onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                            <div class="options-list">
                                <div class="option-item" data-value="" onclick="selectCustomOption('', 'Select ..', 'log_${ev.id}_channel')">Select ..</div>
                            </div>
                        </div>
                    </div>

                    <div class="color-input-wrapper">
                        <label>COLOR</label>
                        <div class="color-picker-custom" style="background: ${color}">
                            <input type="color" id="log_${ev.id}_color" value="${color}" oninput="this.parentElement.style.background = this.value; setDirty(true)">
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // After populating, trigger dropdown display updates
            populateAutomodDropdowns();
            lucide.createIcons();
        }

        function populateAutomodDropdowns() {
            if (!window.lastStatsData || !window.lastStatsData.bots) return;

            const select = document.getElementById('moduleSelect');
            if (!select) return;

            // Use the string ID (product_id) for stats lookup instead of numeric ID
            const selectedOpt = select.options[select.selectedIndex];
            if (!selectedOpt) return;

            const mid = selectedOpt.getAttribute('data-mid');
            if (!mid) {
                console.warn(" [!] populateAutomodDropdowns: Selected option has no data-mid");
                return;
            }

            const botData = window.lastStatsData.bots[mid];
            if (!botData) {
                console.warn(` [!] populateAutomodDropdowns: No bot data found for mid: ${mid} in lastStatsData.bots`, Object.keys(window.lastStatsData.bots));
                return;
            }
            if (!botData.servers) {
                console.warn(` [!] populateAutomodDropdowns: Bot ${mid} has no server data yet.`);
                return;
            }

            // Combine all channels and roles from all servers the bot is in
            let allChannels = [];
            let allRoles = [];

            botData.servers.forEach(srv => {
                if (srv.channels) {
                    srv.channels.forEach(ch => {
                        allChannels.push({ id: ch.id, name: ch.name });
                    });
                }
                if (srv.roles) {
                    srv.roles.forEach(rl => {
                        allRoles.push({ id: rl.id, name: rl.name, color: rl.color });
                    });
                }
            });

            const populateContainer = (containerId, items, prefix, keyOverride) => {
                const container = document.querySelector(`#${containerId} .options-list`);
                if (!container) return;

                // Extract key from containerId if not provided
                // e.g. select_am_ignored_channels_container -> am_ignored_channels
                const key = keyOverride || containerId.replace('select_', '').replace('_container', '');

                container.innerHTML = `<div class="option-item" data-value="" onclick="selectCustomOption('', 'Select ..', '${key}')">Select ..</div>`;

                items.forEach(item => {
                    const opt = document.createElement('div');
                    opt.className = 'option-item';
                    opt.setAttribute('data-value', item.id);
                    if (item.color && item.color !== '0') {
                        opt.style.borderLeft = `3px solid ${item.color}`;
                    }
                    opt.textContent = prefix + item.name;
                    opt.onclick = () => selectCustomOption(item.id, prefix + item.name, key);
                    container.appendChild(opt);
                });
            };

            // 1. Automod Channels
            ['am_ignored_channels', 'am_images_channels', 'am_youtube_channels', 'automod_disabled_channels'].forEach(k => {
                populateContainer(`select_${k}_container`, allChannels, '#');
            });

            // 2. Automod Roles
            ['am_ignored_roles', 'automod_disabled_roles', 'auto_roles', 'auto_roles_bots'].forEach(k => {
                populateContainer(`select_${k}_container`, allRoles, '@');
            });

            // 3. Log Channels
            if (typeof logEvents !== 'undefined') {
                logEvents.forEach(ev => {
                    populateContainer(`select_log_${ev.id}_channel_container`, allChannels, '#');
                });
            }

            // 4. Advanced Responder
            populateContainer('select_adv_disabled_channels_container', allChannels, '#', 'adv_disabled_channels');
            populateContainer('select_adv_enabled_roles_container', allRoles, '@', 'adv_enabled_roles');

            // 5. Moderation Command Modal
            populateContainer('select_mod_enabled_roles_container', allRoles, '@', 'mod_enabled_roles');
            populateContainer('select_mod_disabled_roles_container', allRoles, '@', 'mod_disabled_roles');
            populateContainer('select_mod_enabled_channels_container', allChannels, '#', 'mod_enabled_channels');
            populateContainer('select_mod_disabled_channels_container', allChannels, '#', 'mod_disabled_channels');

            // 6. Refresh all displays to match current hidden values
            document.querySelectorAll('.custom-select input[type="hidden"]').forEach(h => {
                const inputId = h.id.replace('cfg_', '');
                updateDropdownDisplay(inputId);
            });
        }

        window.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-select')) {
                document.querySelectorAll('.custom-select').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.log-card, .widget-card').forEach(c => c.style.zIndex = 'auto');
            }
        });

        fetchPublicStats();
        setInterval(fetchPublicStats, 300000); // Increased to 5m to prevent rate-limit

        window.onload = init;
    </script>
    <!-- Feedback Modal -->
    <div class="modal-overlay" id="feedbackModal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="closeFeedbackModal()"><i data-lucide="x"></i></span>
            <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 24px;">Share your feedback</h2>
            <form onsubmit="submitFeedback(event)">
                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: var(--text-dim);">Target
                        Module (Optional)</label>
                    <div class="custom-select" id="select_module_container">
                        <input type="hidden" name="module_id" id="feedback_module_value" value="0">
                        <div class="select-trigger" onclick="toggleCustomSelect(this)">
                            <span>General Feedback</span>
                            <i data-lucide="chevron-down" style="width: 16px;"></i>
                        </div>
                        <div class="select-options" id="select_module_options">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: var(--text-dim);">Rating</label>
                    <div class="custom-select" id="select_rating_container">
                        <input type="hidden" name="rating" id="feedback_rating_value" value="5">
                        <div class="select-trigger" onclick="toggleCustomSelect(this)">
                            <span>â­â­â­â­â­ (Excellent)</span>
                            <i data-lucide="chevron-down" style="width: 16px;"></i>
                        </div>
                        <div class="select-options">
                            <div class="option-item selected" data-value="5"
                                onclick="selectOption(5, 'â­â­â­â­â­ (Excellent)', 'rating')">â­â­â­â­â­ (Excellent)</div>
                            <div class="option-item" data-value="4" onclick="selectOption(4, 'â­â­â­â­ (Good)', 'rating')">
                                â­â­â­â­ (Good)</div>
                            <div class="option-item" data-value="3"
                                onclick="selectOption(3, 'â­â­â­ (Average)', 'rating')">â­â­â­ (Average)</div>
                            <div class="option-item" data-value="2" onclick="selectOption(2, 'â­â­ (Poor)', 'rating')">â­â­
                                (Poor)</div>
                            <div class="option-item" data-value="1" onclick="selectOption(1, 'â­ (Bad)', 'rating')">â­
                                (Bad)</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: var(--text-dim);">Message</label>
                    <textarea name="message" required placeholder="Write your feedback here..."
                        style="width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); border-radius: 12px; color: white; font-size: 14px; min-height: 120px; resize: vertical; font-family: inherit;"></textarea>
                </div>

                <button type="submit" id="feedbackSubmitBtn"
                    style="width: 100%; padding: 14px; background: #4ade80; color: #000; border: none; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s;">
                    Submit Feedback
                </button>
            </form>
        </div>
    </div>

    <!-- Advanced Responder Modal -->
    <div class="modal-overlay" id="responderModalOverlay" onclick="closeResponderModal()"></div>
    <div class="responder-modal" id="responderModal">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
            <h2 style="margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.02em;">ADD RESPONSE</h2>
            <button onclick="closeResponderModal()"
                style="background: none; border: none; color: var(--text-dim); cursor: pointer;">
                <i data-lucide="x" style="width: 24px;"></i>
            </button>
        </div>

        <div class="responder-field-group">
            <div class="responder-input-wrapper">
                <label>Trigger</label>
                <input type="text" id="adv_responder_trigger" placeholder="Enter trigger word...">
            </div>
            <div style="display: flex; align-items: center; gap: 24px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label class="switch small"><input type="checkbox" id="adv_responder_wildcard"><span
                            class="slider round"></span></label>
                    <span style="font-size: 13px; font-weight: 600;">Wildcard</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label class="switch small"><input type="checkbox" id="adv_responder_reply"><span
                            class="slider round"></span></label>
                    <span style="font-size: 13px; font-weight: 600;">Send as a reply</span>
                </div>
            </div>
        </div>

        <div class="responder-input-wrapper" style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="margin: 0;">Response <span class="badge-random">1</span></label>
                <div style="display: flex; gap: 8px;">
                    <span class="variable-tag" onclick="insertVariable('[user]')">[user]</span>
                    <span class="variable-tag" onclick="insertVariable('[userName]')">[userName]</span>
                    <span class="variable-tag" onclick="insertVariable('[invites]')">[invites]</span>
                </div>
            </div>
            <textarea id="adv_responder_response" placeholder="Type your response here..."></textarea>
        </div>

        <div class="responder-grid-advanced" style="margin-bottom: 32px;">
            <div>
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Enabled
                    Roles</label>
                <div class="custom-select" id="select_adv_enabled_roles_container">
                    <input type="hidden" id="cfg_adv_enabled_roles" value="">
                    <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select ..</span><i
                            data-lucide="chevron-down" style="width: 16px;"></i></div>
                    <div class="select-options">
                        <input type="text" class="dropdown-search" placeholder="Search roles..."
                            onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                        <div class="options-list" id="adv_enabled_roles_list"></div>
                    </div>
                </div>
            </div>
            <div>
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Disabled
                    Channels</label>
                <div class="custom-select" id="select_adv_disabled_channels_container">
                    <input type="hidden" id="cfg_adv_disabled_channels" value="">
                    <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select ..</span><i
                            data-lucide="chevron-down" style="width: 16px;"></i></div>
                    <div class="select-options">
                        <input type="text" class="dropdown-search" placeholder="Search channels..."
                            onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                        <div class="options-list" id="adv_disabled_channels_list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 12px;">
            <button onclick="closeResponderModal()" class="btn-master"
                style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); width: auto; padding: 12px 24px;">Cancel</button>
            <button onclick="saveAdvancedResponse()" class="btn-master" style="width: auto; padding: 12px 32px;">Save
                Changes</button>
        </div>
    </div>

    <!-- Moderation Command Modal -->
    <div class="modal-overlay" id="moderationModalOverlay" onclick="closeModerationModal()"></div>
    <div class="responder-modal" id="moderationModal">
        <span class="close-modal" onclick="closeModerationModal()"><i data-lucide="x"></i></span>
        <h2 id="moderation-modal-title" style="font-size: 22px; font-weight: 700; margin-bottom: 8px;"></h2>
        <p id="moderation-modal-desc" style="font-size: 13px; color: var(--text-dim); margin-bottom: 32px;"></p>

        <div class="responder-input-wrapper" style="margin-bottom: 24px;">
            <label>ALIASES</label>
            <input type="text" id="mod_aliases" placeholder="Create ..">
        </div>

        <div class="responder-grid-advanced" style="margin-bottom: 24px;">
            <div>
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Enabled
                    Roles</label>
                <div class="custom-select" id="select_mod_enabled_roles_container">
                    <input type="hidden" id="cfg_mod_enabled_roles" value="">
                    <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select ..</span><i
                            data-lucide="chevron-down" style="width: 16px;"></i></div>
                    <div class="select-options">
                        <input type="text" class="dropdown-search" placeholder="Search roles..."
                            onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                        <div class="options-list" id="mod_enabled_roles_list"></div>
                    </div>
                </div>
            </div>
            <div>
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Disabled
                    Roles</label>
                <div class="custom-select" id="select_mod_disabled_roles_container">
                    <input type="hidden" id="cfg_mod_disabled_roles" value="">
                    <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select ..</span><i
                            data-lucide="chevron-down" style="width: 16px;"></i></div>
                    <div class="select-options">
                        <input type="text" class="dropdown-search" placeholder="Search roles..."
                            onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                        <div class="options-list" id="mod_disabled_roles_list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="responder-grid-advanced" style="margin-bottom: 24px;">
            <div>
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Enabled
                    Channels</label>
                <div class="custom-select" id="select_mod_enabled_channels_container">
                    <input type="hidden" id="cfg_mod_enabled_channels" value="">
                    <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select ..</span><i
                            data-lucide="chevron-down" style="width: 16px;"></i></div>
                    <div class="select-options">
                        <input type="text" class="dropdown-search" placeholder="Search channels..."
                            onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                        <div class="options-list" id="mod_enabled_channels_list"></div>
                    </div>
                </div>
            </div>
            <div>
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Disabled
                    Channels</label>
                <div class="custom-select" id="select_mod_disabled_channels_container">
                    <input type="hidden" id="cfg_mod_disabled_channels" value="">
                    <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select ..</span><i
                            data-lucide="chevron-down" style="width: 16px;"></i></div>
                    <div class="select-options">
                        <input type="text" class="dropdown-search" placeholder="Search channels..."
                            onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                        <div class="options-list" id="mod_disabled_channels_list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Command-specific options -->
        <div id="mod-ban-options" style="display: none; margin-bottom: 24px;">
            <div class="responder-grid-advanced" style="margin-bottom: 16px;">
                <div>
                    <label
                        style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Delete
                        Message History</label>
                    <div class="custom-select">
                        <div class="select-trigger" onclick="toggleCustomSelect(this)"><span
                                id="mod_ban_delete_history_display">None</span><i data-lucide="chevron-down"
                                style="width: 16px;"></i></div>
                        <div class="select-options">
                            <div class="option-item" onclick="selectModerationOption('delete_history', 'None')">None
                            </div>
                            <div class="option-item"
                                onclick="selectModerationOption('delete_history', 'Previous Hour')">Previous Hour</div>
                            <div class="option-item"
                                onclick="selectModerationOption('delete_history', 'Previous 6 Hours')">Previous 6 Hours
                            </div>
                            <div class="option-item"
                                onclick="selectModerationOption('delete_history', 'Previous 12 Hours')">Previous 12
                                Hours</div>
                            <div class="option-item"
                                onclick="selectModerationOption('delete_history', 'Previous 24 Hours')">Previous 24
                                Hours</div>
                            <div class="option-item"
                                onclick="selectModerationOption('delete_history', 'Previous 3 Days')">Previous 3 Days
                            </div>
                            <div class="option-item"
                                onclick="selectModerationOption('delete_history', 'Previous 7 Days')">Previous 7 Days
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="mod_ban_delete_history" value="None">
                </div>
                <div>
                    <label
                        style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Action
                        if time isn't specified</label>
                    <div class="custom-select">
                        <div class="select-trigger" onclick="toggleCustomSelect(this)"><span
                                id="mod_ban_time_action_display">ban for specific time</span><i
                                data-lucide="chevron-down" style="width: 16px;"></i></div>
                        <div class="select-options">
                            <div class="option-item"
                                onclick="selectModerationOption('time_action', 'ban for specific time')">ban for
                                specific time</div>
                            <div class="option-item" onclick="selectModerationOption('time_action', 'ban permanently')">
                                ban permanently</div>
                        </div>
                    </div>
                    <input type="hidden" id="mod_ban_time_action" value="ban for specific time">
                </div>
            </div>
            <div class="responder-input-wrapper" id="mod-ban-time-input" style="margin-bottom: 16px;">
                <label>A SPECIFIED TIME</label>
                <div style="display: flex; gap: 12px;">
                    <input type="text" id="mod_ban_time_value" placeholder="A specified time" style="flex: 1;">
                    <div class="custom-select" style="width: 140px;">
                        <div class="select-trigger" onclick="toggleCustomSelect(this)"><span
                                id="mod_ban_time_unit_display">Minutes</span><i data-lucide="chevron-down"
                                style="width: 16px;"></i></div>
                        <div class="select-options">
                            <div class="option-item" onclick="selectModerationOption('time_unit', 'Minutes')">Minutes
                            </div>
                            <div class="option-item" onclick="selectModerationOption('time_unit', 'Hours')">Hours</div>
                            <div class="option-item" onclick="selectModerationOption('time_unit', 'Days')">Days</div>
                        </div>
                    </div>
                    <input type="hidden" id="mod_ban_time_unit" value="Minutes">
                </div>
            </div>
        </div>

        <div id="mod-timeout-options" style="display: none; margin-bottom: 24px;">
            <div class="responder-grid-advanced" style="margin-bottom: 16px;">
                <div>
                    <label
                        style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">Action
                        if time isn't specified</label>
                    <div class="custom-select">
                        <div class="select-trigger" onclick="toggleCustomSelect(this)"><span
                                id="mod_timeout_time_action_display">timeout for specific time</span><i
                                data-lucide="chevron-down" style="width: 16px;"></i></div>
                        <div class="select-options">
                            <div class="option-item"
                                onclick="selectModerationOption('timeout_action', 'timeout for specific time')">timeout
                                for specific time</div>
                        </div>
                    </div>
                    <input type="hidden" id="mod_timeout_time_action" value="timeout for specific time">
                </div>
                <div></div>
            </div>
            <div class="responder-input-wrapper">
                <label>A SPECIFIED TIME</label>
                <div style="display: flex; gap: 12px;">
                    <input type="text" id="mod_timeout_time_value" placeholder="A specified time" style="flex: 1;">
                    <div class="custom-select" style="width: 140px;">
                        <div class="select-trigger" onclick="toggleCustomSelect(this)"><span
                                id="mod_timeout_time_unit_display">Minutes</span><i data-lucide="chevron-down"
                                style="width: 16px;"></i></div>
                        <div class="select-options">
                            <div class="option-item" onclick="selectModerationOption('timeout_unit', 'Minutes')">Minutes
                            </div>
                            <div class="option-item" onclick="selectModerationOption('timeout_unit', 'Hours')">Hours
                            </div>
                            <div class="option-item" onclick="selectModerationOption('timeout_unit', 'Days')">Days</div>
                        </div>
                    </div>
                    <input type="hidden" id="mod_timeout_time_unit" value="Minutes">
                </div>
            </div>
        </div>

        <!-- Auto-delete toggles (for all commands) -->
        <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <span style="font-size: 14px; font-weight: 500;">Auto-Delete with message deletion</span>
                <label class="switch"><input type="checkbox" id="mod_auto_delete_message"><span
                        class="slider round"></span></label>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <span style="font-size: 14px; font-weight: 500;">Auto-delete command invocation message</span>
                <label class="switch"><input type="checkbox" id="mod_auto_delete_command"><span
                        class="slider round"></span></label>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 14px; font-weight: 500;">Auto-delete bot's reply message after 5 seconds</span>
                <label class="switch"><input type="checkbox" id="mod_auto_delete_reply"><span
                        class="slider round"></span></label>
            </div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 12px;">
            <button onclick="closeModerationModal()" class="btn-master"
                style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); width: auto; padding: 12px 24px;">Cancel</button>
            <button onclick="saveModerationConfig()" class="btn-master" style="width: auto; padding: 12px 32px;">Save
                Changes</button>
        </div>
    </div>

    <!-- Automod Filter Modal -->
    <div class="modal-overlay" id="automodModalOverlay" onclick="closeAutomodModal()"></div>
    <div class="responder-modal" id="automodModal">
        <span class="close-modal" onclick="closeAutomodModal()"><i data-lucide="x"></i></span>
        <h2 id="automod-modal-title" style="font-size: 22px; font-weight: 700; margin-bottom: 32px;"></h2>

        <!-- Response Options -->
        <div style="margin-bottom: 24px;">
            <label
                style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">CHOOSE
                THE RESPONSE</label>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <label class="response-option"
                    style="display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="automod_response" value="block" checked
                        style="width: 20px; height: 20px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Block Message</div>
                        <div style="font-size: 12px; color: var(--text-dim);">Block messages containing these words from
                            being posted</div>
                    </div>
                </label>
                <label class="response-option"
                    style="display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="automod_response" value="mute"
                        style="width: 20px; height: 20px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Mute Member</div>
                        <div style="font-size: 12px; color: var(--text-dim);">Block the member from sending messages for
                            specific time</div>
                    </div>
                </label>
                <label class="response-option" id="automod-timeout-option"
                    style="display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="automod_response" value="timeout"
                        style="width: 20px; height: 20px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Timeout Member</div>
                        <div style="font-size: 12px; color: var(--text-dim);">Block the member from sending messages,
                            react to messages, join voice channels</div>
                    </div>
                </label>
                <label class="response-option" id="automod-ban-option"
                    style="display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="automod_response" value="ban"
                        style="width: 20px; height: 20px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Ban Member</div>
                        <div style="font-size: 12px; color: var(--text-dim);">Permanently remove the member from the
                            server</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Disabled Channels -->
        <div class="responder-grid-advanced" style="margin-bottom: 24px;">
            <div>
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">DISABLED
                    CHANNELS</label>
                <div class="custom-select" id="select_automod_disabled_channels_container">
                    <input type="hidden" id="cfg_automod_disabled_channels" value="">
                    <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select ..</span><i
                            data-lucide="chevron-down" style="width: 16px;"></i></div>
                    <div class="select-options">
                        <input type="text" class="dropdown-search" placeholder="Search channels..."
                            onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                        <div class="options-list" id="automod_disabled_channels_list"></div>
                    </div>
                </div>
            </div>
            <div>
                <label
                    style="display: block; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.05em;">DISABLED
                    ROLES</label>
                <div class="custom-select" id="select_automod_disabled_roles_container">
                    <input type="hidden" id="cfg_automod_disabled_roles" value="">
                    <div class="select-trigger" onclick="toggleCustomSelect(this)"><span>Select ..</span><i
                            data-lucide="chevron-down" style="width: 16px;"></i></div>
                    <div class="select-options">
                        <input type="text" class="dropdown-search" placeholder="Search roles..."
                            onclick="event.stopPropagation()" oninput="filterDropdownOptions(this)">
                        <div class="options-list" id="automod_disabled_roles_list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spam Specific -->
        <div id="automod-spam-options" style="display: none; margin-bottom: 24px;">
            <div class="responder-input-wrapper">
                <label>SPAM THRESHOLD (MESSAGES PER 5 SECONDS)</label>
                <input type="number" id="automod_spam_threshold" placeholder="e.g., 5" min="2" max="20">
            </div>
        </div>

        <!-- Bad Words Specific -->
        <div id="automod-badwords-options" style="display: none; margin-bottom: 24px;">
            <div class="responder-input-wrapper" style="margin-bottom: 16px;">
                <label>BAD WORDS</label>
                <input type="text" id="automod_badwords_list" placeholder="Create ..">
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 14px; font-weight: 500;">DON'T MATCH IF IT IS PART OF A WORD</span>
                <label class="switch"><input type="checkbox" id="automod_badwords_partial"><span
                        class="slider round"></span></label>
            </div>
        </div>

        <!-- Links Specific -->
        <div id="automod-links-options" style="display: none; margin-bottom: 24px;">
            <div class="responder-input-wrapper" style="margin-bottom: 16px;">
                <label>WHITELIST URLS</label>
                <input type="text" id="automod_whitelist_urls" placeholder="Create ..">
            </div>
            <div class="responder-input-wrapper">
                <label>BLACKLIST LINKS</label>
                <input type="text" id="automod_blacklist_links" placeholder="Create ..">
            </div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 32px;">
            <button onclick="closeAutomodModal()" class="btn-master"
                style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); width: auto; padding: 12px 24px;">Cancel</button>
            <button onclick="saveAutomodConfig()" class="btn-master" style="width: auto; padding: 12px 32px;">Save
                Changes</button>
        </div>
    </div>

    <!-- Unsaved Changes Bar -->
    <div id="unsavedChangesBar"
        style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(20, 20, 30, 0.98); backdrop-filter: blur(10px); border-top: 1px solid var(--border); padding: 16px 24px; display: none; align-items: center; justify-content: center; gap: 16px; z-index: 9999; box-shadow: 0 -4px 20px rgba(0,0,0,0.3);">
        <div style="display: flex; align-items: center; gap: 12px;">
            <i data-lucide="alert-circle" style="width: 20px; height: 20px; color: #f59e0b;"></i>
            <span style="font-size: 14px; font-weight: 600; color: white;">Careful â€” you have unsaved changes!</span>
        </div>
        <div style="display: flex; gap: 12px;">
            <button onclick="discardChanges()"
                style="padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                Reset
            </button>
            <button onclick="saveModuleConfig()"
                style="padding: 10px 24px; background: var(--accent); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                Save Changes
            </button>
        </div>
    </div>

</body>

</html>